'use client';

import { useEffect, useRef, useState } from 'react';
import {
  Settings,
  Copy,
  RotateCcw,
  ArrowUp,
  Plus,
  Search,
  FileText,
  AlertTriangle,
  Paperclip,
  X,
  Folder,
  User2,
  LogOut,
} from 'lucide-react';

import { Button } from '../../components/ui/button';
import {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
} from '../../components/ui/dropdown-menu';

import { useChatController } from '../useChatController';
import { useChatStore, ChatMessage } from '../../store/chat';
import { useUserStore } from '../../store/user';
import Cookies from 'js-cookie';
import s from './ChatArea.module.css';
import LoginPromptModal from './LoginPromptModal';
import { logoutFirebase } from '@/app/lib/firebase';
import MakeSafetyDocs from './MakeSafetyDocs';

const TYPE_META: Record<string, { label: string; emoji: string }> = {
  environment: { label: 'í™˜ê²½/ì•ˆì „', emoji: 'ğŸŒ±' },
  infosec: { label: 'ì •ë³´ë³´ì•ˆ', emoji: 'ğŸ›¡ï¸' },
};

type TaskType =
  | 'law_research'
  | 'doc_review'
  | 'risk_assessment'
  | 'law_interpret'
  | 'edu_material'
  | 'guideline_interpret'
  | 'accident_search';

const TASK_META: Record<TaskType, { label: string }> = {
  law_research: { label: 'ë²•ë ¹ ì¡°ì‚¬' },
  doc_review: { label: 'ì•ˆì „ ë¬¸ì„œ ìƒì„±/ê²€í† ' },
  risk_assessment: { label: 'ìœ„í—˜ì„± í‰ê°€' },
  law_interpret: { label: 'AI ë²•ë ¹ í•´ì„' },
  edu_material: { label: 'êµìœ¡ìë£Œ ìƒì„±' },
  guideline_interpret: { label: 'ì‹¤ë¬´ì§€ì¹¨ í•´ì„' },
  accident_search: { label: 'ì‚¬ê³ ì‚¬ë¡€ ê²€ìƒ‰' },
};

type QuickAction = {
  id: string;
  label: string;
  icon: React.ComponentType<{ className?: string }>;
  placeholder: string;
  taskType?: TaskType;
};

const QUICK_ACTIONS: QuickAction[] = [
  {
    id: 'accident_search',
    label: 'ì‚¬ê³ ì‚¬ë¡€ ê²€ìƒ‰',
    icon: Search,
    placeholder: 'ì§€ê²Œì°¨, í¬ë ˆì¸ ë“± íŠ¹ì • ì„¤ë¹„ì™€ ê´€ë ¨ëœ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì¤˜.',
    taskType: 'accident_search',  
  },
  {
    id: 'today_accident',
    label: 'ê¸ˆì£¼ì˜ ì•ˆì „ ë‰´ìŠ¤',
    icon: AlertTriangle,
    placeholder: 'ì´ë²ˆ ì£¼ ì‚°ì—…ì•ˆì „/ë³´ê±´ ê´€ë ¨ ì£¼ìš” ë‰´ìŠ¤ë¥¼ ì •ë¦¬í•´ì¤˜.',
    taskType: 'law_research',
  },
  {
    id: 'notice_summary',
    label: 'ì…ë²• ì˜ˆê³  ìš”ì•½',
    icon: FileText,
    placeholder:
      'ì²¨ë¶€í•œ ì…ë²•ì˜ˆê³ ë¬¸ì„ ì•ˆì „/ë³´ê±´ ê´€ì ì—ì„œ í•µì‹¬ë§Œ ìš”ì•½í•´ì¤˜.',
    taskType: 'doc_review',
  },
  {
    id: 'doc_create',
    label: 'ì•ˆì „ ë¬¸ì„œ ìƒì„±',
    icon: FileText,
    placeholder:
      'ì–´ë–¤ ì•ˆì „ ë¬¸ì„œë¥¼ ë§Œë“¤ì§€ ì•Œë ¤ì£¼ë©´ í…œí”Œë¦¿ì„ ë§Œë“¤ì–´ì¤„ê²Œ.',
    taskType: 'doc_review',
  },
  {
    id: 'doc_review',
    label: 'ì•ˆì „ ë¬¸ì„œ ê²€í† ',
    icon: FileText,
    placeholder:
      'ì²¨ë¶€í•œ ì•ˆì „ ë¬¸ì„œì˜ ëˆ„ë½ëœ í•­ëª©ê³¼ ê°œì„ ì ì„ ê²€í† í•´ì¤˜.',
    taskType: 'doc_review',
  },
  {
    id: 'risk_assess',
    label: 'ìœ„í—˜ì„± í‰ê°€',
    icon: AlertTriangle,
    placeholder:
      'ì§€ì •í•œ ê³µì •ì— ëŒ€í•´ KOSHA ê°€ì´ë“œ ê¸°ì¤€ìœ¼ë¡œ ìœ„í—˜ì„±í‰ê°€ë¥¼ ë„ì™€ì¤˜.',
    taskType: 'risk_assessment',
  },
  {
    id: 'law_interpret',
    label: 'AI ë²•ë ¹ í•´ì„',
    icon: FileText,
    placeholder:
      'ì‚°ì—…ì•ˆì „ë³´ê±´ë²• ì œ000ì¡°ë¥¼ í˜„ì¥ ë‹´ë‹¹ìê°€ ì´í•´í•˜ê¸° ì‰½ê²Œ í’€ì´í•´ì¤˜.',
    taskType: 'law_interpret',
  },
  {
    id: 'edu_material',
    label: 'êµìœ¡ìë£Œ ìƒì„±',
    icon: FileText,
    placeholder:
      'ì‹ ì… ì§ì› êµìœ¡ìš© ì‚°ì—…ì•ˆì „ êµìœ¡ìë£Œ ê°œìš”ë¥¼ ë§Œë“¤ì–´ì¤˜.',
    taskType: 'edu_material',
  },
  {
    id: 'guideline_interpret',
    label: 'ì‹¤ë¬´ì§€ì¹¨ í•´ì„',
    icon: FileText,
    placeholder:
      'ìš°ë¦¬ ì‚¬ì—…ì¥(ì—…ì¢…, ê·œëª¨, ì£¼ìš” ê³µì •)ì— ë§ëŠ” ì•ˆì „ë³´ê±´ ì‹¤ë¬´ì§€ì¹¨ì„ ì •ë¦¬í•´ì¤˜.',
    taskType: 'guideline_interpret',
  },
];

type SafetyDocGuide = {
  intro: string;
  fields: string[];
  downloadLabel?: string;
  downloadUrl?: string;
};

export const SAFETY_DOC_GUIDES: Record<string, SafetyDocGuide> = {
  /* =========================
   * 1) êµìœ¡Â·ì•ˆì „ê´€ë¦¬ ê³„íš/í‰ê°€ ê´€ë ¨
   * ========================= */

  'goal-plan': {
    intro:
      'ì•ˆì „ë³´ê±´ ëª©í‘œ ì¶”ì§„ê³„íš(ì•ˆ)ì„ ì‘ì„±í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì •ë¦¬í•´ ì£¼ì„¸ìš”.',
    fields: [
      'Â· ê³„íš ê¸°ê°„(ì—°ë„Â·ë¶„ê¸° ë“±)',
      'Â· ì‚¬ì—…ì¥/ê³µì • ê°œìš”ì™€ ìƒì‹œ ê·¼ë¡œì ìˆ˜',
      'Â· ì„¤ì •í•˜ë ¤ëŠ” ì£¼ìš” ì•ˆì „ë³´ê±´ ëª©í‘œ(ì˜ˆ: ì¬í•´ìœ¨, êµìœ¡ ì´ìˆ˜ìœ¨, ìœ„í—˜ì„±í‰ê°€ ì™„ë£Œìœ¨ ë“±)',
      'Â· ê° ëª©í‘œë³„ ì„¸ë¶€ ì¶”ì§„ê³¼ì œì™€ KPI(ì§€í‘œ)',
      'Â· ê³¼ì œë³„ ë‹´ë‹¹ ë¶€ì„œì™€ ì±…ì„ì',
      'Â· ì›”ë³„Â·ë¶„ê¸°ë³„ ì¶”ì§„ ì¼ì •ê³¼ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤',
      'Â· í•„ìš”í•œ ì˜ˆì‚°Â·ì¸ë ¥Â·ì„¤ë¹„ ë“± ìì› ê³„íš',
      'Â· ê³„íš ì´í–‰ ìƒí™©ì„ ì ê²€Â·ë³´ê³ í•˜ëŠ” ë°©ë²•(íšŒì˜, ë³´ê³ ì„œ ë“±)',
    ],
    downloadLabel: 'ì¶”ì§„ê³„íš(ì•ˆ) ê¸°ë³¸ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/goal-plan.docx',
  },

  'edu-plan-result': {
    intro:
      'êµìœ¡í›ˆë ¨ ê³„íšëŒ€ë¹„ ì‹¤ì  ê²°ê³¼í‘œ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒ í•­ëª©ì„ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ëŒ€ìƒ ê¸°ê°„(ì—°ë„Â·ì›” ë˜ëŠ” ë¶„ê¸°)',
      'Â· ê³„íší•œ êµìœ¡ ê³¼ì • ëª©ë¡(ë²•ì •/ììœ¨ êµìœ¡ êµ¬ë¶„ í¬í•¨)',
      'Â· ê° ê³¼ì •ë³„ ê³„íš ì¸ì›, ê³„íš íšŸìˆ˜, ê³„íš êµìœ¡ì‹œê°„',
      'Â· ì‹¤ì œ êµìœ¡ ì‹¤ì‹œ ì¼ìì™€ ì‹œê°„',
      'Â· ì‹¤ì œ ì°¸ì„ ì¸ì›, ì°¸ì„ë¥ , ë¯¸ì°¸ì„ ì‚¬ìœ ',
      'Â· ì™¸ë¶€ ìœ„íƒÂ·ì˜¨ë¼ì¸ êµìœ¡ ë“± íŠ¹ì´ì‚¬í•­',
      'Â· í–¥í›„ ë¯¸ì‹¤ì‹œ/ë¯¸ì´ìˆ˜ ì¸ì›ì— ëŒ€í•œ ë³´ì™„ ê³„íš',
    ],
    downloadLabel: 'ê³„íšëŒ€ë¹„ ì‹¤ì  ê²°ê³¼í‘œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/edu-plan-result.docx',
  },

  'disaster-drill-report': {
    intro:
      'ë¹„ìƒì¬ë‚œ ëŒ€ì‘í›ˆë ¨ ê²°ê³¼ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· í›ˆë ¨ ëª…ì¹­ê³¼ ëŒ€ìƒ ì¬ë‚œ ìœ í˜•(í™”ì¬, ì§€ì§„, í™”í•™ë¬¼ì§ˆ ëˆ„ì¶œ ë“±)',
      'Â· í›ˆë ¨ ì¼ì‹œ, ì†Œìš” ì‹œê°„, ì‹¤ì‹œ ë¶€ì„œ',
      'Â· í›ˆë ¨ ì¥ì†Œì™€ ì°¸ì—¬ ì¸ì›(ë¶€ì„œë³„ ì¸ì› í¬í•¨)',
      'Â· í›ˆë ¨ ì‹œë‚˜ë¦¬ì˜¤ì™€ ì£¼ìš” ì§„í–‰ ì ˆì°¨(ëŒ€í”¼, ì´ˆë™ì¡°ì¹˜, ìƒí™© ì „íŒŒ ë“±)',
      'Â· ìœ ê´€ê¸°ê´€(ì†Œë°©ì„œ, ê²½ì°°, í˜‘ë ¥ì—…ì²´ ë“±) ì°¸ì—¬ ì—¬ë¶€ì™€ ì—­í• ',
      'Â· í›ˆë ¨ ì¤‘ ë°œê²¬ëœ ë¬¸ì œì ê³¼ ìš°ìˆ˜ ì‚¬ë¡€',
      'Â· ì¬ë‚œ ëŒ€ì‘ì²´ê³„ ê°œì„ ì‚¬í•­ ë° í›„ì† ì¡°ì¹˜ ê³„íš',
      'Â· ì²¨ë¶€í•  ì‚¬ì§„, ì²´í¬ë¦¬ìŠ¤íŠ¸, ì°¸ì„ë¶€ ë“± ìë£Œ ëª©ë¡',
    ],
    downloadLabel: 'ë¹„ìƒì¬ë‚œ í›ˆë ¨ ê²°ê³¼ë³´ê³ ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/disaster-drill-report.docx',
  },

  'safety-cost-plan': {
    intro:
      'ì•ˆì „ë³´ê±´ë¹„ìš©ê³„íšì„œë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ ë‹¤ìŒì˜ ì˜ˆì‚° ê³„íš ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ê³„íš ê¸°ê°„(ì—°ë„Â·ì‚¬ì—…ì—°ë„ ë“±)',
      'Â· ì‚¬ì—…ì¥ ë˜ëŠ” ì¡°ì§ ë‹¨ìœ„ë³„ ì•ˆì „ë³´ê±´ ì˜ˆì‚° ì´ì•¡',
      'Â· í•­ëª©ë³„ ì˜ˆì‚°(ë³´í˜¸êµ¬, ì•ˆì „êµìœ¡, ì‹œì„¤Â·ì„¤ë¹„ ê°œì„ , ì¸¡ì •Â·ê²€ì‚¬, ê±´ê°•ê²€ì§„ ë“±)',
      'Â· ê° í•­ëª©ë³„ ì‚°ì • ê·¼ê±°(ì¸ì› ìˆ˜, ë‹¨ê°€, ì˜ˆì • ìˆ˜ëŸ‰ ë“±)',
      'Â· ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ íˆ¬ì í•­ëª©ê³¼ ê·¸ ì´ìœ ',
      'Â· ì˜ˆì‚° ì§‘í–‰Â·ê´€ë¦¬ ì±…ì„ ë¶€ì„œì™€ ë‹´ë‹¹ì',
      'Â· ì˜ˆì‚° ì§‘í–‰ ê²°ê³¼ë¥¼ ì ê²€Â·ë³´ê³ í•˜ëŠ” ì£¼ê¸°ì™€ ë°©ë²•',
    ],
    downloadLabel: 'ì•ˆì „ë³´ê±´ë¹„ìš©ê³„íšì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/safety-cost-plan.docx',
  },

  'law-compliance-eval': {
    intro: 'ë²•ê·œì¤€ìˆ˜í‰ê°€ì„œë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ë‚´ìš©ì„ ì •ë¦¬í•´ ì£¼ì„¸ìš”.',
    fields: [
      'Â· í‰ê°€ ëŒ€ìƒ ì‚¬ì—…ì¥ê³¼ í‰ê°€ ì¼ì',
      'Â· ì ìš© ëŒ€ìƒ ì£¼ìš” ë²•ë ¹Â·ê·œì • ëª©ë¡(ì‚°ì—…ì•ˆì „ë³´ê±´ë²•, ì¤‘ëŒ€ì¬í•´ì²˜ë²Œë²• ë“±)',
      'Â· ë²•ë ¹ë³„ë¡œ ì ê²€í•  ì„¸ë¶€ í•­ëª©Â·ì²´í¬ë¦¬ìŠ¤íŠ¸',
      'Â· ì ê²€ ë°©ë²•(ì„œë¥˜ ê²€í† , í˜„ì¥ ì ê²€, ì¸í„°ë·° ë“±)',
      'Â· í•­ëª©ë³„ ì¤€ìˆ˜ ì—¬ë¶€ ê²°ê³¼(ì í•©/ë¶€ì í•©/í•´ë‹¹ ì—†ìŒ ë“±)',
      'Â· ë¶€ì í•© ì‚¬í•­ì˜ ë‚´ìš©, ì›ì¸, ê°œì„  ê³„íš',
      'Â· í‰ê°€ ì°¸ì—¬ ì¸ì›(í‰ê°€ìÂ·ì°¸ì„ì) ë° í™•ì¸Â·ì„œëª… ë°©ì‹',
    ],
    downloadLabel: 'ë²•ê·œì¤€ìˆ˜í‰ê°€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/law-compliance-eval.docx',
  },

  'safety-system-eval': {
    intro:
      'ì•ˆì „ë³´ê±´ê´€ë¦¬ì²´ê³„ í‰ê°€í‘œ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· í‰ê°€ ëŒ€ìƒ ì¡°ì§(ë³¸ì‚¬/ì‚¬ì—…ì¥/ë¼ì¸ ë“±)ê³¼ í‰ê°€ ê¸°ì¤€ì¼',
      'Â· ê²½ì˜ìì˜ ì•ˆì „ë³´ê±´ ë°©ì¹¨Â·ëª©í‘œ ìˆ˜ë¦½ ë° ì´í–‰ ìˆ˜ì¤€',
      'Â· ì•ˆì „ë³´ê±´ ì¡°ì§Â·ì „ë‹´ ì¸ë ¥ êµ¬ì„±ê³¼ ê¶Œí•œ ë¶€ì—¬ í˜„í™©',
      'Â· ìœ„í—˜ì„±í‰ê°€, ì‘ì—…í‘œì¤€, ì ê²€Â·ì‘ì—…í—ˆê°€ì œ ìš´ì˜ ìˆ˜ì¤€',
      'Â· êµìœ¡Â·í›ˆë ¨, ë„ê¸‰Â·í˜‘ë ¥ì—…ì²´ ê´€ë¦¬ ìˆ˜ì¤€',
      'Â· ì‚¬ê³ Â·ì¬í•´ ì¡°ì‚¬ ë° ì¬ë°œë°©ì§€ëŒ€ì±… ìˆ˜ë¦½ ì²´ê³„',
      'Â· ê´€ë¦¬ì²´ê³„ ì „ë°˜ì— ëŒ€í•œ ì¢…í•©í‰ê°€(ë“±ê¸‰, ì½”ë©˜íŠ¸ ë“±)',
      'Â· í–¥í›„ ê°œì„ ì´ í•„ìš”í•œ í•µì‹¬ ê³¼ì œì™€ ì¼ì •',
    ],
    downloadLabel: 'ê´€ë¦¬ì²´ê³„ í‰ê°€í‘œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/safety-system-eval.docx',
  },

  'safety-edu-result-report': {
    intro:
      'ì•ˆì „ë³´ê±´êµìœ¡ ê²°ê³¼ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ ì•„ë˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· êµìœ¡ ì œëª©ê³¼ êµìœ¡ ëª©ì ',
      'Â· êµìœ¡ ëŒ€ìƒ(ì§ë¬´, ì§ê¸‰, ì¸ì›ìˆ˜ ë“±)',
      'Â· êµìœ¡ ì¼ì‹œ, ì¥ì†Œ, ì´ êµìœ¡ ì‹œê°„',
      'Â· êµìœ¡ ë°©ì‹(ì§‘ì²´, ì˜¨ë¼ì¸, ì‹¤ìŠµ ë“±)',
      'Â· ì‹¤ì œ ì°¸ì„ì ëª…ë‹¨ê³¼ ì°¸ì„ë¥ , ê²°ì› ì‚¬ìœ ',
      'Â· ì£¼ìš” êµìœ¡ ë‚´ìš©ê³¼ í˜„ì¥ì—ì„œ ê°•ì¡°í•œ í•µì‹¬ ë©”ì‹œì§€',
      'Â· ì´í•´ë„Â·ë§Œì¡±ë„ í‰ê°€ ê²°ê³¼(ì„¤ë¬¸, í€´ì¦ˆ ë“±)',
      'Â· ì¶”ê°€ë¡œ í•„ìš”í•œ ë³´ì™„ êµìœ¡ì´ë‚˜ í›„ì† ì¡°ì¹˜ ê³„íš',
    ],
    downloadLabel: 'êµìœ¡ ê²°ê³¼ë³´ê³ ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/safety-edu-result-report.docx',
  },

  'emergency-drill-report': {
    intro:
      'ë¹„ìƒì‚¬íƒœ ëŒ€ì‘ í›ˆë ¨ ê²°ê³¼ ë³´ê³ ì„œ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒì˜ ë‚´ìš©ì„ ì•Œë ¤ì£¼ì„¸ìš”.',
    // ğŸ‘‰ ìŠ¤ìƒ·ì— ë‚˜ì˜¨ ë¬¸êµ¬ ê·¸ëŒ€ë¡œ
    fields: [
      'Â· í›ˆë ¨ ì°¸ê°€ì ëª…ë‹¨',
      'Â· í›ˆë ¨ ì‹¤ì‹œ ë¶€ì„œ',
      'Â· í›ˆë ¨ ë‚´ìš©',
      'Â· í›ˆë ¨ ì¥ì†Œ',
      'Â· í›ˆë ¨ ì´ë¯¸ì§€ 2ê°œ ì´ìƒ ì²¨ë¶€',
      'Â· ê·¸ ì™¸ ë³´ê³ ì„œ ë‚´ ì‘ì„±í•´ì•¼ í•  ì •ë³´',
    ],
    downloadLabel: 'ê²°ê³¼ë³´ê³ ì„œ ê¸°ë³¸ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/emergency-drill-report.docx',
  },

  /* =========================
   * 2) íšŒì˜Â·í˜‘ì˜ì²´ ê´€ë ¨
   * ========================= */

  'worker-participation-minutes': {
    intro: 'ê·¼ë¡œì ì°¸ì—¬í˜‘ì˜ë¡ ì‘ì„±ì„ ìœ„í•´ íšŒì˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· íšŒì˜ ì¼ì‹œì™€ ì¥ì†Œ',
      'Â· íšŒì˜ ëª…ì¹­ê³¼ ì£¼ê´€ ë¶€ì„œ',
      'Â· ì°¸ì„ì ëª…ë‹¨(ê·¼ë¡œì ëŒ€í‘œ, ê´€ë¦¬ì ë“±)',
      'Â· ë…¼ì˜í•œ ì£¼ìš” ì•ˆê±´(ì‘ì—…í™˜ê²½, ì•ˆì „ ê°œì„ , ë³µì§€ ë“±)',
      'Â· ì•ˆê±´ë³„ ì œê¸°ëœ ì˜ê²¬ê³¼ ì§ˆì˜ ë‚´ìš©',
      'Â· í•©ì˜ëœ ì¡°ì¹˜ ì‚¬í•­, ë‹´ë‹¹ì, ì™„ë£Œ ì˜ˆì •ì¼',
      'Â· ì°¨ê¸° íšŒì˜ ì¼ì • ë° í›„ì† ê´€ë¦¬ ê³„íš',
    ],
    downloadLabel: 'ê·¼ë¡œì ì°¸ì—¬í˜‘ì˜ë¡ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/worker-participation-minutes.docx',
  },

  'safety-council-minutes': {
    intro: 'ì•ˆì „ë³´ê±´ í˜‘ì˜ì²´ íšŒì˜ë¡ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· í˜‘ì˜ì²´ ëª…ì¹­, íšŒì˜ ì¼ì‹œì™€ ì¥ì†Œ',
      'Â· ì°¸ì„ì ëª…ë‹¨(ì›ì²­Â·í˜‘ë ¥ì—…ì²´, ë…¸ì‚¬ ëŒ€í‘œ ë“±)',
      'Â· íšŒì˜ ì•ˆê±´(ì¬í•´ í˜„í™©, ìœ„í—˜ì„±í‰ê°€, ê³µì‚¬ ì¼ì • ë“±)',
      'Â· ì•ˆê±´ë³„ ë³´ê³  ë‚´ìš©ê³¼ ë…¼ì˜ ì‚¬í•­',
      'Â· ê²°ì •ëœ ì‚¬í•­ê³¼ ì´í–‰ ì±…ì„ ë¶€ì„œÂ·ê¸°í•œ',
      'Â· ë¯¸í•´ê²° ì•ˆê±´ ë° ì°¨ê¸° íšŒì˜ì—ì„œ ë‹¤ë£° ì‚¬í•­',
    ],
    downloadLabel: 'ì•ˆì „ë³´ê±´ í˜‘ì˜ì²´ íšŒì˜ë¡ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/safety-council-minutes.docx',
  },

  'safety-fair-meeting-minutes': {
    intro: 'ì•ˆì „ê³µì •íšŒì˜ íšŒì˜ë¡ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒ ë‚´ìš©ì„ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· íšŒì˜ ì¼ì‹œÂ·ì¥ì†ŒÂ·ì°¸ì„ ë¶€ì„œ',
      'Â· í•´ë‹¹ ê³µì • ë˜ëŠ” ì‘ì—…ì˜ ê°œìš”(ì‘ì—… ë‚´ìš©, ì¼ì • ë“±)',
      'Â· ê³µì •ë³„ ì£¼ìš” ìœ„í—˜ìš”ì¸ê³¼ ë…¼ì˜ëœ ì•ˆì „ëŒ€ì±…',
      'Â· ê³µì •Â·ì‘ì—… ìˆœì„œìƒì˜ ë³€ê²½ ì‚¬í•­ ë° ì˜í–¥',
      'Â· í•„ìš”í•œ ì¶”ê°€ ì•ˆì „ì¡°ì¹˜, ì¸ë ¥Â·ì¥ë¹„ ì§€ì› ì‚¬í•­',
      'Â· íšŒì˜ì—ì„œ í•©ì˜ëœ follow-up ì¡°ì¹˜ì™€ ë‹´ë‹¹ì',
    ],
    downloadLabel: 'ì•ˆì „ê³µì •íšŒì˜ íšŒì˜ë¡ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/safety-fair-meeting-minutes.docx',
  },

  'suggestion-hearing-form': {
    intro: 'ê±´ì˜ì‚¬í•­ ì²­ì·¨í‘œ ì‘ì„±ì„ ìœ„í•´ ê±´ì˜ ë‚´ìš©ì„ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ê±´ì˜ì ì •ë³´(ì„±ëª…, ì†Œì†, ì—°ë½ì²˜ ë“±)',
      'Â· ê±´ì˜ ì ‘ìˆ˜ ì¼ì‹œì™€ ì¥ì†Œ',
      'Â· ê±´ì˜ ìœ í˜•(ì•ˆì „, ë³´ê±´, í™˜ê²½, ë³µì§€ ë“±)',
      'Â· í˜„ì¬ ë¬¸ì œ ìƒí™© ë˜ëŠ” ìœ„í—˜ìš”ì¸ ì„¤ëª…',
      'Â· ê±´ì˜ìê°€ ì œì•ˆí•˜ëŠ” ê°œì„  ì•„ì´ë””ì–´Â·ì¡°ì¹˜ ì‚¬í•­',
      'Â· ê²€í†  ê²°ê³¼(ìˆ˜ìš©/ë³´ì™„/ë³´ë¥˜ ë“±)ì™€ ê·¸ ì‚¬ìœ ',
      'Â· ì‹¤ì œ ì‹¤í–‰ ì—¬ë¶€ì™€ í›„ì† ì¡°ì¹˜ ë‚´ìš©',
    ],
    downloadLabel: 'ê±´ì˜ì‚¬í•­ ì²­ì·¨í‘œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/suggestion-hearing-form.docx',
  },

  /* =========================
   * 3) ì¼ìƒì ê²€Â·ì‘ì—…ê´€ë¦¬
   * ========================= */

  'tbm-log': {
    intro: 'TBM í™œë™ì¼ì§€ë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· TBM ì‹¤ì‹œ ì¼ì‹œì™€ ì¥ì†Œ(ì‘ì—… ìœ„ì¹˜)',
      'Â· ì°¸ì„ì ëª…ë‹¨ê³¼ ì‘ì—… ë°˜/ì¡° í¸ì„±',
      'Â· ë‹¹ì¼ ì‘ì—… ë‚´ìš©ê³¼ ê³µì • ê°œìš”',
      'Â· ì‘ì—… ì „ ê³µìœ í•œ ìœ„í—˜ìš”ì¸ê³¼ ì•ˆì „ì¡°ì¹˜ ì‚¬í•­',
      'Â· ì‘ì—…ì ì˜ê²¬Â·ì§ˆë¬¸, íŠ¹ì´ì‚¬í•­',
      'Â· ë‹¹ì¼ ì•ˆì „ ê°•ì¡° ë©”ì‹œì§€ ë˜ëŠ” ìŠ¬ë¡œê±´',
    ],
    downloadLabel: 'TBM í™œë™ì¼ì§€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/tbm-log.docx',
  },

  'heat-illness-control-sheet': {
    intro: 'ì˜¨ì—´ì§ˆí™˜ ê´€ë¦¬í‘œ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒ ë°ì´í„°ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ê´€ë¦¬ ëŒ€ìƒ ì‚¬ì—…ì¥Â·ì‘ì—…ì¥ ì •ë³´',
      'Â· ê·¼ë¡œì ëª…ë‹¨(ê³ ìœ„í—˜êµ° ì—¬ë¶€ í¬í•¨)',
      'Â· ì‘ì—… ì‹œê°„ëŒ€ë³„ ê¸°ì˜¨/ìŠµë„ ë˜ëŠ” WBGT ì¸¡ì •ê°’',
      'Â· ë¬´ë”ìœ„ ì‹œê°„ëŒ€ ì‘ì—… ì¡°ì •Â·íœ´ì‹ ì‹œê°„ ê³„íš',
      'Â· ëƒ‰ë°©Â·í™˜ê¸°Â·ìŒë£Œ ì œê³µ ë“±ì˜ ë³´í˜¸ ì¡°ì¹˜ ë‚´ìš©',
      'Â· ì˜¨ì—´ì§ˆí™˜ ì˜ì‹¬ ì¦ìƒ ë°œìƒ ì—¬ë¶€ì™€ ì¡°ì¹˜ ë‚´ìš©',
    ],
    downloadLabel: 'ì˜¨ì—´ì§ˆí™˜ ê´€ë¦¬í‘œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/heat-illness-control-sheet.docx',
  },

  'ppe-issue-ledger': {
    intro: 'ë³´í˜¸êµ¬ ì§€ê¸‰ ëŒ€ì¥ì„ ì‘ì„±í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ì§€ê¸‰ ëŒ€ìƒ ê·¼ë¡œì ì„±ëª…Â·ì†Œì†Â·ì§ë¬´',
      'Â· ì§€ê¸‰í•œ ë³´í˜¸êµ¬ ì¢…ë¥˜(ì•ˆì „ëª¨, ì•ˆì „í™”, ë³´ì•ˆê²½ ë“±)',
      'Â· ê·œê²©Â·ëª¨ë¸ëª…Â·ì¸ì¦ë²ˆí˜¸ ë“± ì„¸ë¶€ ì‚¬ì–‘',
      'Â· ì§€ê¸‰ ì¼ìì™€ ìˆ˜ëŸ‰',
      'Â· êµì²´ ì˜ˆì •ì¼ ë˜ëŠ” ì‚¬ìš© ê¸°í•œ',
      'Â· ê·¼ë¡œì ì„œëª…Â·ìˆ˜ë ¹ í™•ì¸ ë°©ë²•',
    ],
    downloadLabel: 'ë³´í˜¸êµ¬ ì§€ê¸‰ ëŒ€ì¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/ppe-issue-ledger.docx',
  },

  'work-plan': {
    intro: 'ì‘ì—…ê³„íšì„œ ì‘ì„±ì„ ìœ„í•´ ì‘ì—… ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ì‘ì—… ëª…ì¹­ê³¼ ì‘ì—… ê°œìš”(ê³µì •, ì„¤ë¹„, ìœ„ì¹˜ ë“±)',
      'Â· ì‘ì—… ê¸°ê°„ê³¼ ì¼ì •(ì‹œì‘Â·ì¢…ë£Œ ì˜ˆì •ì¼)',
      'Â· íˆ¬ì… ì¸ì›(ì§ë¬´Â·ìˆ™ë ¨ë„ ë“±)ê³¼ ì¥ë¹„Â·ë„êµ¬ ëª©ë¡',
      'Â· ì‘ì—… ìˆœì„œ(ë‹¨ê³„ë³„ ì£¼ìš” ë‚´ìš©)',
      'Â· ë‹¨ê³„ë³„ ì ì¬ ìœ„í—˜ìš”ì¸ê³¼ ì•ˆì „ì¡°ì¹˜ ê³„íš',
      'Â· í•„ìš”í•œ ì‘ì—…í—ˆê°€, êµìœ¡, ìê²©ìš”ê±´ ë“±',
    ],
    downloadLabel: 'ì‘ì—…ê³„íšì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/work-plan.docx',
  },

  'work-permit': {
    intro: 'ì‘ì—…í—ˆê°€ì„œ(ìœ„í—˜ì‘ì—… í—ˆê°€) ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒ ë‚´ìš©ì„ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· í—ˆê°€ ëŒ€ìƒ ì‘ì—… ì¢…ë¥˜(ë°€íê³µê°„, í™”ì¬ìœ„í—˜, ê³ ì†Œì‘ì—… ë“±)',
      'Â· ì‘ì—… ì¥ì†Œì™€ ê³µì •Â·ì„¤ë¹„ ì •ë³´',
      'Â· ì‘ì—… ì˜ˆì • ì¼ì‹œì™€ ì˜ˆìƒ ì†Œìš” ì‹œê°„',
      'Â· ì‘ì—… ì „ ì‹œí–‰í•´ì•¼ í•  ì•ˆì „ì¡°ì¹˜(ê°€ìŠ¤ë†ë„ ì¸¡ì •, Lock-out/Tag-out ë“±)',
      'Â· í•„ìš” ìê²©Â·êµìœ¡ ì´ìˆ˜ ì—¬ë¶€ í™•ì¸ ë‚´ìš©',
      'Â· í—ˆê°€ ë°œí–‰ìÂ·ê°ë…ìÂ·ì‘ì—…ì ì„œëª…/í™•ì¸ ì ˆì°¨',
    ],
    downloadLabel: 'ì‘ì—…í—ˆê°€ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/work-permit.docx',
  },

  'daily-safety-council-minutes': {
    intro:
      'ì¼ìƒì ì¸ ì•ˆì „ë³´ê±´ í˜‘ì˜ì²´ íšŒì˜ë¡ ì‘ì„±ì„ ìœ„í•´ ì•„ë˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· íšŒì˜ ì¼ì‹œì™€ ì¥ì†Œ',
      'Â· ì°¸ì„ì ëª…ë‹¨ ë° ì†Œì†',
      'Â· ë‹¹ì¼ ì‘ì—…Â·ê³µì • í˜„í™© ìš”ì•½',
      'Â· í˜„ì•ˆ ì´ìŠˆ(ì‚¬ê³ , ì•„ì°¨ì‚¬ê³ , ë¯¼ì› ë“±)',
      'Â· ë…¼ì˜ëœ ìœ„í—˜ìš”ì¸ê³¼ ê°œì„ ì¡°ì¹˜ ë‚´ìš©',
      'Â· ì¡°ì¹˜ ë‹´ë‹¹ì, ì™„ë£Œ ëª©í‘œì¼, follow-up ê³„íš',
    ],
    downloadLabel: 'ì¼ìƒ í˜‘ì˜ì²´ íšŒì˜ë¡ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/daily-safety-council-minutes.docx',
  },

  'msds-list': {
    intro:
      'ë¬¼ì§ˆì•ˆì „ë³´ê±´ìë£Œëª©ë¡í‘œ(MSDS) ì‘ì„±ì„ ìœ„í•´ í™”í•™ë¬¼ì§ˆ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ì·¨ê¸‰ ì¤‘ì¸ í™”í•™ë¬¼ì§ˆëª…(ì œí’ˆëª…, ì„±ë¶„ëª… ë“±)',
      'Â· CAS No., í•¨ìœ  ë†ë„, í˜¼í•©ë¬¼ ì—¬ë¶€',
      'Â· ë³´ê´€ ì¥ì†Œì™€ ì‚¬ìš© ê³µì •Â·ì„¤ë¹„ ì •ë³´',
      'Â· ì—°ê°„ ì‚¬ìš©ëŸ‰ ë˜ëŠ” ë³´ê´€ëŸ‰',
      'Â· ìœ„í—˜Â·ìœ í•´ì„± ë¶„ë¥˜ì™€ ì£¼ìš” ìœ„í—˜ìš”ì¸',
      'Â· ë³´ìœ  ì¤‘ì¸ MSDS ë°œí–‰ì²˜, ê°œì • ì¼ì, ì–¸ì–´ ë“±',
    ],
    downloadLabel: 'MSDS ëª©ë¡í‘œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/msds-list.docx',
  },

  'work-stop-request-log': {
    intro:
      'ì‘ì—…ì¤‘ì§€ìš”ì²­ ê¸°ë¡ëŒ€ì¥ì„ ì‘ì„±í•˜ê¸° ìœ„í•´ ìš”ì²­ ë‚´ì—­ì„ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ì‘ì—…ì¤‘ì§€ ìš”ì²­ ì¼ì‹œì™€ ìš”ì²­ì(ì„±ëª…, ì†Œì†)',
      'Â· ì‘ì—… ìœ„ì¹˜ì™€ ì‘ì—… ë‚´ìš©',
      'Â· ì‘ì—…ì¤‘ì§€ë¥¼ ìš”ì²­í•œ êµ¬ì²´ì  ì‚¬ìœ (ìœ„í—˜ìš”ì¸, ì‚¬ê³  ì§•í›„ ë“±)',
      'Â· í˜„ì¥ì—ì„œ ì¦‰ì‹œ ì·¨í•œ ì¡°ì¹˜ ë‚´ìš©',
      'Â· ì‘ì—… ì¬ê°œ ìŠ¹ì¸ ì¼ì‹œì™€ ìŠ¹ì¸ì',
      'Â· ì¶”ê°€ ê°œì„ ì¡°ì¹˜ ë° ì¬ë°œë°©ì§€ ê³„íš',
    ],
    downloadLabel: 'ì‘ì—…ì¤‘ì§€ìš”ì²­ ê¸°ë¡ëŒ€ì¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/work-stop-request-log.docx',
  },

  'work-stop-request-form': {
    intro: 'ì‘ì—…ì¤‘ì§€ ìš”ì²­ì„œ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ìš”ì²­ì ì„±ëª…Â·ì†Œì†Â·ì—°ë½ì²˜',
      'Â· ìš”ì²­ ì¼ì‹œì™€ ì‘ì—… ìœ„ì¹˜',
      'Â· í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‘ì—… ë‚´ìš©',
      'Â· ì¦‰ì‹œ ì¤‘ì§€í•´ì•¼ í•œë‹¤ê³  íŒë‹¨í•œ êµ¬ì²´ì  ìœ„í—˜ ìƒí™©',
      'Â· ì‘ì—… ì¤‘ì§€ ë²”ìœ„(ê³µì •Â·ì„¤ë¹„Â·êµ¬ì—­ ë“±)',
      'Â· ìš”ì²­ìì˜ ì˜ê²¬ ë° ê¸´ê¸‰ ê°œì„ ì´ í•„ìš”í•œ ì‚¬í•­',
    ],
    downloadLabel: 'ì‘ì—…ì¤‘ì§€ ìš”ì²­ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/work-stop-request-form.docx',
  },

  /* =========================
   * 4) ì¬í•´Â·ì‚¬ê³  ê´€ë¦¬
   * ========================= */

  'industrial-accident-investigation': {
    intro: 'ì‚°ì—…ì¬í•´ì¡°ì‚¬í‘œ ì‘ì„±ì„ ìœ„í•´ ì‚¬ê³  ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ì‚¬ê³  ë°œìƒ ì¼ì‹œì™€ ì¥ì†Œ(í˜„ì¥, ì„¤ë¹„, ê³µì • ë“±)',
      'Â· í”¼ì¬ì ì¸ì ì‚¬í•­(ì„±ëª…, ì†Œì†, ì§ë¬´, ê²½ë ¥ ë“±)',
      'Â· ì‚¬ê³  ìœ í˜•(ì¶”ë½, í˜‘ì°©, ì „ë„, ê°ì „ ë“±)ê³¼ ìƒí•´ ì •ë„',
      'Â· ì‚¬ê³  ë°œìƒ ê²½ìœ„(ì‹œê°„ ìˆœì„œëŒ€ë¡œ)',
      'Â· ì§ì ‘ ì›ì¸(ë¶ˆì•ˆì „í•œ í–‰ë™Â·ìƒíƒœ)ê³¼ ê°„ì ‘Â·ë°°ê²½ ì›ì¸',
      'Â· ì¦‰ì‹œ ì¡°ì¹˜ ë‚´ìš©(ì‘ê¸‰ì¡°ì¹˜, ì‘ì—…ì¤‘ì§€ ë“±)',
      'Â· ì¬ë°œë°©ì§€ ëŒ€ì±…(ê³µì • ê°œì„ , êµìœ¡, ë³´í˜¸êµ¬ ë“±)',
    ],
    downloadLabel: 'ì‚°ì—…ì¬í•´ì¡°ì‚¬í‘œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/industrial-accident-investigation.docx',
  },

  'accident-report': {
    intro: 'ì¬í•´ë³´ê³ ì„œ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒ ë‚´ìš©ì„ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ì¬í•´ ë°œìƒ ì¼ì‹œì™€ ì¥ì†Œ',
      'Â· ì¬í•´ ìœ í˜•ê³¼ í”¼í•´ ê·œëª¨(ì¸ì Â·ë¬¼ì  í”¼í•´)',
      'Â· ì¬í•´ ë°œìƒ ë‹¹ì‹œ ì‘ì—… ë‚´ìš©ê³¼ í™˜ê²½',
      'Â· ì¬í•´ ì›ì¸ì— ëŒ€í•œ ìš”ì•½ ë¶„ì„',
      'Â· ì¦‰ì‹œ ì¡°ì¹˜ ë° ì‘ê¸‰ ëŒ€ì‘ ë‚´ìš©',
      'Â· ê´€ê³„ ê¸°ê´€ ì‹ ê³  ì—¬ë¶€ ë° ì²˜ë¦¬ í˜„í™©',
      'Â· í–¥í›„ ì¬ë°œë°©ì§€ë¥¼ ìœ„í•œ ì£¼ìš” ê°œì„ ì‚¬í•­',
    ],
    downloadLabel: 'ì¬í•´ë³´ê³ ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/accident-report.docx',
  },

  'near-miss-investigation-report': {
    intro: 'ì•„ì°¨ì‚¬ê³  ì¡°ì‚¬ ë³´ê³ ì„œ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ì•„ì°¨ì‚¬ê³  ë°œìƒ ì¼ì‹œì™€ ì¥ì†Œ',
      'Â· ê´€ë ¨ ì‘ì—… ë‚´ìš©ê³¼ ì‚¬ìš© ì„¤ë¹„Â·ë„êµ¬',
      'Â· ë°œìƒ ë‹¹ì‹œ ìƒí™© ë° â€œì¡°ê¸ˆë§Œ ë” í–ˆìœ¼ë©´â€ ì¼ì–´ë‚  ìˆ˜ ìˆì—ˆë˜ í”¼í•´',
      'Â· ë°œìƒ ì›ì¸(ì‘ì—… ë°©ë²•, ì¥ë¹„ ìƒíƒœ, ì£¼ë³€ í™˜ê²½ ë“±)',
      'Â· ìœ ì‚¬ ì‚¬ê³  ì¬ë°œ ê°€ëŠ¥ì„±ì´ ë†’ì€ ê³µì •Â·ì¡°ê±´',
      'Â· ì¬ë°œë°©ì§€ë¥¼ ìœ„í•œ ê°œì„ ì¡°ì¹˜ì™€ ê´€ë¦¬ë°©ì•ˆ',
    ],
    downloadLabel: 'ì•„ì°¨ì‚¬ê³  ì¡°ì‚¬ ë³´ê³ ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/near-miss-investigation-report.docx',
  },

  /* =========================
   * 5) ë²•ì • ì„ ì„Â·ìê²©Â·í‰ê°€
   * ========================= */

  'safety-person-eval': {
    intro:
      'ì•ˆì „ë³´ê±´ê´€ê³„ì í‰ê°€í‘œ ì‘ì„±ì„ ìœ„í•´ í‰ê°€ ëŒ€ìƒì ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· í‰ê°€ ëŒ€ìƒì ì„±ëª…, ì§ìœ„, ë‹´ë‹¹ ì—­í• (ì•ˆì „ë³´ê±´ê´€ë¦¬ì±…ì„ì ë“±)',
      'Â· í‰ê°€ ê¸°ê°„ê³¼ í‰ê°€ ê¸°ì¤€(ì—° 1íšŒ ë“±)',
      'Â· í‰ê°€ í•­ëª©(ë²•ë ¹ ì´í•´ë„, ì´í–‰ ìˆ˜ì¤€, ë¦¬ë”ì‹­, ì˜ì‚¬ì†Œí†µ ë“±)',
      'Â· ê° í•­ëª©ë³„ í‰ê°€ ë“±ê¸‰ ë˜ëŠ” ì ìˆ˜',
      'Â· ì£¼ìš” ê°•ì ê³¼ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì— ëŒ€í•œ ì½”ë©˜íŠ¸',
      'Â· ì¢…í•© í‰ê°€ ì˜ê²¬ê³¼ í–¥í›„ êµìœ¡Â·ì§€ì› ê³„íš',
    ],
    downloadLabel: 'ì•ˆì „ë³´ê±´ê´€ê³„ì í‰ê°€í‘œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/safety-person-eval.docx',
  },

  'supervisor-eval': {
    intro: 'ê´€ë¦¬ ê°ë…ì í‰ê°€í‘œ ì‘ì„±ì„ ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ê´€ë¦¬ê°ë…ì ì„±ëª…, ì†Œì†, ë‹´ë‹¹ ê³µì •Â·ë¼ì¸',
      'Â· í‰ê°€ ê¸°ê°„ê³¼ ê·¼ë¬´ í˜•íƒœ(ì£¼Â·ì•¼ê°„, êµëŒ€ ë“±)',
      'Â· ì¼ìƒ ì ê²€Â·TBMÂ·ì‘ì—…í—ˆê°€ ê´€ë¦¬ ìˆ˜í–‰ ì •ë„',
      'Â· ìœ„í—˜ì„±í‰ê°€ ë°˜ì˜ ë° ì‘ì—… í‘œì¤€ ì¤€ìˆ˜ ê´€ë¦¬ ìˆ˜ì¤€',
      'Â· ë¶€í•˜ ì§ì›ì— ëŒ€í•œ êµìœ¡Â·ì§€ë„Â·í”¼ë“œë°± ì‚¬ë¡€',
      'Â· ì‚¬ê³ Â·ì•„ì°¨ì‚¬ê³  ë°œìƒ ì‹œ ëŒ€ì‘ ë° ì¬ë°œë°©ì§€ ë…¸ë ¥',
      'Â· ì¢…í•© í‰ê°€ ë“±ê¸‰ê³¼ í–¥í›„ ìœ¡ì„± ê³„íš',
    ],
    downloadLabel: 'ê´€ë¦¬ ê°ë…ì í‰ê°€í‘œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/supervisor-eval.docx',
  },

  'safety-qualification-register': {
    intro:
      'ì•ˆì „ë³´ê±´ ìê²©ë“±ë¡ ëª©ë¡ë¶€ ì‘ì„±ì„ ìœ„í•´ ë³´ìœ  ìê²© ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ìê²© ë³´ìœ ì ì„±ëª…, ì†Œì†, ì§ë¬´',
      'Â· ë³´ìœ  ìê²©ëª…(ì‚°ì—…ì•ˆì „ê¸°ì‚¬, ìœ„í—˜ë¬¼ê¸°ëŠ¥ì‚¬ ë“±)',
      'Â· ìê²©ë²ˆí˜¸, ë°œê¸‰ê¸°ê´€, ì·¨ë“ì¼ì',
      'Â· ìœ íš¨ê¸°ê°„ ë˜ëŠ” ê°±ì‹  í•„ìš” ì—¬ë¶€',
      'Â· ìê²©ê³¼ ì—°ê´€ëœ ë‹´ë‹¹ ì—…ë¬´ ë˜ëŠ” ì—­í• ',
      'Â· í–¥í›„ ì·¨ë“ ì˜ˆì •ì¸ ìê²© ë° ê³„íš',
    ],
    downloadLabel: 'ìê²©ë“±ë¡ ëª©ë¡ë¶€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/safety-qualification-register.docx',
  },

  'safety-person-appointment-report': {
    intro:
      'ì•ˆì „ë³´ê±´ê´€ê³„ì ì„ ì„ ë“± ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ì„ ì„ ëŒ€ìƒ ì§ì±…(ì•ˆì „ë³´ê±´ê´€ë¦¬ì±…ì„ì, ê´€ë¦¬ê°ë…ì ë“±)',
      'Â· ì„ ì„ ëŒ€ìƒì ì„±ëª…, ì†Œì†, ì§ìœ„',
      'Â· ì„ ì„ ì¼ìì™€ ì ìš© ì‚¬ì—…ì¥ ë²”ìœ„',
      'Â· ì„ ì„ì˜ ë²•ì  ê·¼ê±°(ê´€ë ¨ ì¡°í•­, ê¸°ì¤€ ë“±)',
      'Â· ê²¸ì§ ì—¬ë¶€, ì´ì „ ì„ ì„ìì™€ì˜ ì¸ìˆ˜ì¸ê³„ ë‚´ìš©',
      'Â· ë³´ê³  ëŒ€ìƒ ê¸°ê´€(ê´€í•  ì§€ë°©ê³ ìš©ë…¸ë™ê´€ì„œ ë“±)ê³¼ ë³´ê³  ë°©ë²•',
    ],
    downloadLabel: 'ì„ ì„ ë“± ë³´ê³ ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/safety-person-appointment-report.docx',
  },

  'safety-person-appointment-doc': {
    intro:
      'ì•ˆì „ë³´ê±´ê´€ê³„ì ì„ ì„ ë° ì§€ì •ì„œ ì‘ì„±ì„ ìœ„í•´ ì•„ë˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.',
    fields: [
      'Â· ì„ ì„Â·ì§€ì •í•  ì§ë¬´(ì•ˆì „ê´€ë¦¬ì, ë³´ê±´ê´€ë¦¬ì, ê°ì‹œì¸ ë“±)',
      'Â· ëŒ€ìƒì ì„±ëª…, ì†Œì†, ì§ìœ„, ë‹´ë‹¹ ì—…ë¬´',
      'Â· ì„ ì„Â·ì§€ì • ì¼ìì™€ ìœ íš¨ ê¸°ê°„',
      'Â· ë¶€ì—¬ë˜ëŠ” ê¶Œí•œê³¼ ì±…ì„ ë²”ìœ„',
      'Â· ë³´ê³ Â·í˜‘ì˜Â·ê²°ì¬ ë¼ì¸ ë“± ì˜ì‚¬ì†Œí†µ ì²´ê³„',
      'Â· ëŒ€í‘œì ë˜ëŠ” ê¶Œí•œëŒ€í–‰ìì˜ ì„œëª…Â·ë‚ ì¸ ì •ë³´',
    ],
    downloadLabel: 'ì„ ì„ ë° ì§€ì •ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ',
    downloadUrl: '/templates/safety-person-appointment-doc.docx',
  },
};

type SafetyNewsResponse = {
  id: string;
  category?: string;
  period?: string | null;
  batch_date?: string;
  digest: string;
  source_count?: number | null;
};
type LawNoticeSummaryResponse = {
  id?: string | null;
  run_date?: string | null;
  cutoff_date?: string | null;
  months_back?: number | null;
  item_count?: number | null;

  // ì˜ˆì „ safety-news ìŠ¤íƒ€ì¼
  digest?: string | null;

  // í˜¹ì‹œ ë°±ì—”ë“œê°€ í‰íƒ„í™”í•´ì„œ ì¤„ ìˆ˜ë„ ìˆìŒ
  summary_kor?: string | null;

  // ì§€ê¸ˆ ì‹¤ì œë¡œ ì˜¤ëŠ” êµ¬ì¡°(text.summary_kor)
  text?: {
    summary_kor?: string;
    [key: string]: any;
  } | null;
};

type QuickActionGroup = {
  id: string;
  title: string;
  icon: React.ComponentType<{ className?: string }>;
  items: QuickAction['id'][];
};

const QUICK_ACTION_GROUPS: QuickActionGroup[] = [
  {
    id: 'practice',
    title: 'ì‹¤ë¬´ í•´ì„',
    icon: FileText,
    items: ['guideline_interpret', 'law_interpret'],
  },
  {
    id: 'accident_news',
    title: 'ì‚¬ê³  Â· ë‰´ìŠ¤',
    icon: AlertTriangle,
    items: ['accident_search', 'today_accident', 'notice_summary'],
  },
  {
    id: 'docs_materials',
    title: 'ë¬¸ì„œ Â· ìë£Œ',
    icon: Folder,
    items: ['doc_create', 'doc_review', 'edu_material', 'risk_assess'],
  },
];

const QUICK_ACTIONS_MAP: Record<string, QuickAction> = QUICK_ACTIONS.reduce(
  (acc, cur) => {
    acc[cur.id] = cur;
    return acc;
  },
  {} as Record<string, QuickAction>,
);

// ğŸ”¹ ì¶”ê°€: ê²ŒìŠ¤íŠ¸ ì œí•œ ìƒìˆ˜ + ì¿ í‚¤ í‚¤
const GUEST_LIMIT = 3;
const GUEST_LIMIT_COOKIE_KEY = 'regai_guest_msg_count';

// ğŸ”¹ ì¶”ê°€: ì¿ í‚¤ì—ì„œ ì¹´ìš´íŠ¸ ì½ê¸°
const getGuestMsgCountFromCookie = () => {
  const raw = Cookies.get(GUEST_LIMIT_COOKIE_KEY);
  if (!raw) return 0;
  const n = parseInt(raw, 10);
  if (Number.isNaN(n) || n < 0) return 0;
  return n;
};

// ğŸ”¹ ì¶”ê°€: ì¿ í‚¤ì— ì¹´ìš´íŠ¸ ì“°ê¸°
const setGuestMsgCountToCookie = (value: number) => {
  Cookies.set(GUEST_LIMIT_COOKIE_KEY, String(value), {
    // ë©°ì¹  ë™ì•ˆ ìœ ì§€í• ì§€ ì›í•˜ëŠ” ê°’ìœ¼ë¡œ
    expires: 7, // 7ì¼ ë™ì•ˆ ìœ ì§€
  });
};

export default function ChatArea() {
  const {
    messages,
    input,
    setInput,
    loading,
    loadingMessageIndex,
    LOADING_MESSAGES,
    statusMessage,
    sendMessage,
    regenerate,
  } = useChatController();

  const [showLanding, setShowLanding] = useState(true);

  // âœ… user / clearFirebaseUser ë„ ê°™ì´ êº¼ë‚´ê¸°
  const { selectedJobType, setSelectedJobType, user, clearFirebaseUser } =
    useUserStore();
  const [showTypeModal, setShowTypeModal] = useState(false);

  // ì‘ì—… ì„ íƒ ëª¨ë‹¬ + ì„ íƒëœ ì‘ì—…
  const [showTaskModal, setShowTaskModal] = useState(false);
  const [selectedTask, setSelectedTask] =
    useState<TaskType | null>('guideline_interpret');

  // âœ… ë¡œê·¸ì¸ ëª¨ë‹¬ on/off
  const [showLoginModal, setShowLoginModal] = useState(false);

  // ì²¨ë¶€ íŒŒì¼
  const [attachments, setAttachments] = useState<File[]>([]);
  const fileInputRef = useRef<HTMLInputElement | null>(null);

  const setMessages = useChatStore((st) => st.setMessages);
  const openRightFromHtml = useChatStore((st) => st.openRightFromHtml);

  const bootOnce = useRef(false);

  const [copied, setCopied] = useState(false);

  const contentRefs = useRef<Record<number, HTMLDivElement | null>>({});

  const endRef = useRef<HTMLDivElement>(null);
  useEffect(() => {
    endRef.current?.scrollIntoView({ behavior: 'smooth', block: 'end' });
  }, [messages, loading, loadingMessageIndex]);

  // âœ… ê³„ì • ë²„íŠ¼ í´ë¦­: ë¹„ë¡œê·¸ì¸ â†’ ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸°
  const handleAccountButtonClick = () => {
    if (!user) {
      setShowLoginModal(true);
    }
  };

  // âœ… ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (Google / Kakao ë¶„ê¸°)
  const handleLogout = async () => {
    try {
      const w = window as any;
      if (user?.provider === 'kakao' && w?.Kakao?.Auth) {
        w.Kakao.Auth.logout();
      } else {
        await logoutFirebase();
      }
    } catch (err) {
      console.error('[ChatArea] logout error:', err);
    } finally {
      clearFirebaseUser?.();
    }
  };

  type HintTask =
  | 'law_interpret'
  | 'guideline_interpret'
  | 'doc_create'
  | 'edu_material'
  | 'accident_search';

  const [activeHintTask, setActiveHintTask] = useState<HintTask | null>(null);
  const [activeHints, setActiveHints] = useState<string[]>([]);

  const DOC_REVIEW_INTRO_TEXT =
    'ë²•ë ¹ ê·¼ê±°ë¥¼ ê²€í† í•˜ì—¬ ë³´ì™„ì‚¬í•­ì„ í™•ì¸í•  ì•ˆì „ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';

  const LAW_INTRO_TEXT =
    'ë²•ë ¹ê³¼ ê·œì œì‚¬í•­ì„ í•™ìŠµí•œ REA AIê°€ ë‚´ ì‚¬ì—…ì¥ì— ë”± ë§ëŠ” ì‹¤ë¬´ì§€ì¹¨ì„ ì•ˆë‚´í•´ë“œë ¤ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?';

  const GUIDELINE_INTRO_TEXT =
    'í˜„ì¥ì˜ ì‘ì—…ì ˆì°¨, ì ê²€í‘œ, êµìœ¡Â·í›ˆë ¨ ë“± ì‹¤ë¬´ì§€ì¹¨ì„ REA AIê°€ ë²•ë ¹ì— ë§ê²Œ ì •ë¦¬í•´ë“œë ¤ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?';

  const DOC_CREATE_INTRO_TEXT =
    'ë²•ì • ì„œì‹ê³¼ KOSHA ê°€ì´ë“œë¥¼ ì°¸ê³ í•´ì„œ í•„ìš”í•œ ì•ˆì „ ë¬¸ì„œë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ë§Œë“¤ì–´ë“œë¦´ê²Œìš”. ì–´ë–¤ ë¬¸ì„œë¥¼ ìƒì„±í• ê¹Œìš”?';

  const LAW_INTERPRET_HINTS: string[] = [
    'ìš°ë¦¬ ì‚¬ì—…ì¥ì˜ ì—…ì¢…, ì¸ì›, ì£¼ìš” ê³µì •ì„ ì•Œë ¤ì¤„í…Œë‹ˆ ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì¼œì•¼ í•  ì•ˆì „ë³´ê±´ ì˜ë¬´ë¥¼ ì •ë¦¬í•´ì¤˜.',
    'ì§€ê²Œì°¨Â·í¬ë ˆì¸ ì‘ì—…ì— ëŒ€í•´ ë²•ë ¹ ê¸°ì¤€ í•„ìˆ˜ ì•ˆì „ìˆ˜ì¹™ê³¼ ë³´í˜¸êµ¬ ì°©ìš© ê¸°ì¤€ì„ ì•Œë ¤ì¤˜.',
    'í™”í•™ë¬¼ì§ˆì„ ì·¨ê¸‰í•˜ëŠ” ê³µì •ì—ì„œ í•„ìš”í•œ êµìœ¡, ë¬¸ì„œ, ë³´í˜¸êµ¬ ì˜ë¬´ì‚¬í•­ì„ ë²•ë ¹ ê¸°ì¤€ìœ¼ë¡œ ì •ë¦¬í•´ì¤˜.',
    'ë„ê¸‰/í•˜ë„ê¸‰ ê³µì‚¬ì—ì„œ ì›ì²­ê³¼ í•˜ì²­ì´ ê°ê° ë¶€ë‹´í•˜ëŠ” ì•ˆì „ë³´ê±´ ì±…ì„ê³¼ ì˜ë¬´ë¥¼ ì •ë¦¬í•´ì¤˜.',
    'ì•¼ê°„ì‘ì—…ì´ë‚˜ êµëŒ€ê·¼ë¬´ê°€ ë§ì€ ì‚¬ì—…ì¥ì—ì„œ ê·¼ë¡œì‹œê°„Â·íœ´ê²Œì‹œê°„ ê´€ë ¨ ë²•ì  ì¤€ìˆ˜ì‚¬í•­ì„ ì•Œë ¤ì¤˜.',
    'ì‚°ì—…ì•ˆì „ë³´ê±´ë²•ìƒ ì•ˆì „ë³´ê±´ê´€ë¦¬ì±…ì„ìì™€ ê´€ë¦¬ê°ë…ìì˜ ì—­í• ê³¼ í•„ìˆ˜ ì—…ë¬´ë¥¼ ì •ë¦¬í•´ì¤˜.',
    'ìµœê·¼ ê°œì •ëœ ì¤‘ëŒ€ì¬í•´ì²˜ë²Œë²•ì´ ìš°ë¦¬ ì—…ì¢…ì— ì–´ë–¤ ì˜ë¬´ë¥¼ ì¶”ê°€ë¡œ ìš”êµ¬í•˜ëŠ”ì§€ ì•Œë ¤ì¤˜.',
    'ë°€íê³µê°„ ì‘ì—… ì‹œ ì ìš©ë˜ëŠ” ë²•ë ¹ê³¼ ë°˜ë“œì‹œ ê°–ì¶°ì•¼ í•  ì ˆì°¨Â·ì„œë¥˜ë¥¼ ì •ë¦¬í•´ì¤˜.',
    'ì‹ ê·œ ì„¤ë¹„ë¥¼ ë„ì…í•  ë•Œ ì•ˆì „ì¸ì¦ì´ë‚˜ ììœ¨ì•ˆì „í™•ì¸ ëŒ€ìƒ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ëŠ” ê¸°ì¤€ì„ ì„¤ëª…í•´ì¤˜.',
    'ì‚°ì—…ì¬í•´ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹ ê³ , ì¡°ì‚¬, ì¬ë°œë°©ì§€ ëŒ€ì±… ìˆ˜ë¦½ê¹Œì§€ ë²•ì—ì„œ ìš”êµ¬í•˜ëŠ” ì ˆì°¨ë¥¼ ì •ë¦¬í•´ì¤˜.',
  ];

  const GUIDELINE_HINTS: string[] = [
    'ìš°ë¦¬ ì‚¬ì—…ì¥ì˜ ì‘ì—… ê³µì •ë³„ë¡œ ê¸°ë³¸ ì•ˆì „ë³´ê±´ ì‹¤ë¬´ì§€ì¹¨(ì‘ì—… ì „Â·ì¤‘Â·í›„ ì ê²€ ì‚¬í•­)ì„ ë§Œë“¤ì–´ì¤˜.',
    'ì§€ê²Œì°¨Â·í¬ë ˆì¸ ì¥ë¹„ ì ê²€ ë° ì‘ì—… ì „ TBMì—ì„œ ì•ˆë‚´í•  ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‹¤ë¬´ì§€ì¹¨ í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•´ì¤˜.',
    'ì‹ ê·œ ì…ì‚¬ì ì•ˆì „ë³´ê±´ ì˜¤ë¦¬ì—”í…Œì´ì…˜ ë•Œ ì‚¬ìš©í•˜ê¸° ì¢‹ì€ êµìœ¡ ì§„í–‰ ìˆœì„œì™€ ì‹¤ë¬´ì§€ì¹¨ì„ ë§Œë“¤ì–´ì¤˜.',
    'ìœ„í—˜ì„±í‰ê°€ ê²°ê³¼ì— ë”°ë¼ í˜„ì¥ì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ê°œì„ ì¡°ì¹˜Â·ê´€ë¦¬ëŒ€ì±… ì‹¤ë¬´ì§€ì¹¨ì„ ì •ë¦¬í•´ì¤˜.',
    'í™”í•™ë¬¼ì§ˆ ì·¨ê¸‰ ì‘ì—…ìì˜ ë³´í˜¸êµ¬ ì§€ê¸‰, ì°©ìš©, ë³´ê´€ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì‹¤ë¬´ì§€ì¹¨ì„ ì‘ì„±í•´ì¤˜.',
    'ë„ê¸‰Â·í•˜ë„ê¸‰ ê³µì‚¬ì—ì„œ ì‘ì—… ì‹œì‘ ì „ í˜‘ì˜ì²´ ìš´ì˜ ë° í•©ë™ì ê²€ ì‹¤ë¬´ì§€ì¹¨ì„ ë§Œë“¤ì–´ì¤˜.',
    'ë°€íê³µê°„ ì‘ì—… ì „ ì‚¬ì „ì ê²€, ì¶œì…í†µì œ, ê°ì‹œì¸ ë°°ì¹˜ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì‹¤ë¬´ì§€ì¹¨ì„ ì‘ì„±í•´ì¤˜.',
    'ì•¼ê°„ì‘ì—… ì‹œ ì¡°ë„ê´€ë¦¬, êµëŒ€ì œ ìš´ì˜, í”¼ë¡œë„ ê´€ë¦¬ ë“±ì„ í¬í•¨í•œ ì‹¤ë¬´ì§€ì¹¨ì„ ì •ë¦¬í•´ì¤˜.',
    'ì‘ì—…ì¤‘ì§€ê¶Œ ë³´ì¥ê³¼ ì¬ê°œ ì ˆì°¨ì— ëŒ€í•´ í˜„ì¥ ê´€ë¦¬ììš© ì‹¤ë¬´ì§€ì¹¨ì„ ë§Œë“¤ì–´ì¤˜.',
    'ì‚°ì—…ì¬í•´ ë°œìƒ ì‹œ ì‘ê¸‰ì¡°ì¹˜, ë³´ê³ , ì¬ë°œë°©ì§€ ëŒ€ì±… ìˆ˜ë¦½ê¹Œì§€ ë‹¨ê³„ë³„ ì‹¤ë¬´ì§€ì¹¨ì„ ì •ë¦¬í•´ì¤˜.',
  ];

  const DOC_CREATE_HINTS: string[] = [
    'ìœ„í—˜ì„±í‰ê°€ì„œ',
    'ì‘ì—…í—ˆê°€ì„œ(ë°€íê³µê°„ ì‘ì—…)',
    'ì§€ê²Œì°¨ ì‘ì—… ì•ˆì „ì ê²€í‘œ',
    'ì •ê¸° ì•ˆì „ë³´ê±´êµìœ¡ ì¼ì§€',
    'TBM(ì‘ì—… ì „ ì•ˆì „íšŒì˜) íšŒì˜ë¡',
    'ì‚°ì—…ì¬í•´ ë°œìƒ ë³´ê³ ì„œ',
    'ë³´í˜¸êµ¬ ì§€ê¸‰Â·ê´€ë¦¬ëŒ€ì¥',
    'ë„ê¸‰Â·í•˜ë„ê¸‰ ì•ˆì „ë³´ê±´í˜‘ì˜ì²´ íšŒì˜ë¡',
    'ìœ„í—˜ì„±í‰ê°€ ê²°ê³¼ ê°œì„ ì¡°ì¹˜ ê´€ë¦¬ëŒ€ì¥',
    'í™”í•™ë¬¼ì§ˆ ì·¨ê¸‰ ì‘ì—… í‘œì¤€ì‘ì—…ì§€ì¹¨ì„œ(SOP)',
  ];

  const EDU_INTRO_TEXT =
    'ì‹ ì…Â·ì •ê¸° êµìœ¡ì— ì“¸ ìˆ˜ ìˆëŠ” ì‚°ì—…ì•ˆì „/ë³´ê±´ êµìœ¡ìë£Œ ê°œìš”ë¥¼ REA AIê°€ ë§Œë“¤ì–´ë“œë ¤ìš”. ì–´ë–¤ êµìœ¡ì´ í•„ìš”í•˜ì‹ ê°€ìš”?';

  const EDU_MATERIAL_HINTS: string[] = [
    'ì‹ ì… ì§ì› ëŒ€ìƒ ê¸°ë³¸ ì‚°ì—…ì•ˆì „/ë³´ê±´ êµìœ¡ìë£Œ',
    'ìœ„í—˜ì„±í‰ê°€ ë°©ë²•ê³¼ ì ˆì°¨ë¥¼ ì„¤ëª…í•˜ëŠ” êµìœ¡ìë£Œ',
    'ì§€ê²Œì°¨Â·í¬ë ˆì¸ ì‘ì—…ì ì•ˆì „ìˆ˜ì¹™ êµìœ¡ìë£Œ',
    'í™”í•™ë¬¼ì§ˆ ì·¨ê¸‰ ì‘ì—…ìë¥¼ ìœ„í•œ ìœ í•´ìœ„í—˜Â·ë³´í˜¸êµ¬ êµìœ¡ìë£Œ',
    'ì¤‘ëŒ€ì¬í•´ì²˜ë²Œë²•ì˜ ì£¼ìš” ë‚´ìš©ê³¼ ê²½ì˜ì±…ì„ì ì˜ë¬´ë¥¼ ì„¤ëª…í•˜ëŠ” êµìœ¡ìë£Œ',
    'ë„ê¸‰Â·í•˜ë„ê¸‰ í˜„ì¥ì˜ ì•ˆì „ë³´ê±´ ì±…ì„ê³¼ ì˜ë¬´ë¥¼ ì„¤ëª…í•˜ëŠ” êµìœ¡ìë£Œ',
    'ë°€íê³µê°„ ì‘ì—… ì•ˆì „ìˆ˜ì¹™ê³¼ ì‚¬ê³ ì‚¬ë¡€ë¥¼ í¬í•¨í•œ êµìœ¡ìë£Œ',
  ];

  const ACCIDENT_INTRO_TEXT =
  'KOSHA ì‚¬ê³ ì‚¬ë¡€ DBì—ì„œ ì›í•˜ëŠ” ì„¤ë¹„Â·ê³µì •ê³¼ ê´€ë ¨ëœ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ ê°œìš”ì™€ ì¬ë°œë°©ì§€ëŒ€ì±…ê¹Œì§€ ì •ë¦¬í•´ë“œë ¤ìš”. ì–´ë–¤ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?';

  const ACCIDENT_HINTS: string[] = [
    'ì§€ê²Œì°¨ ì‘ì—… ì¤‘ ì „ë„Â·ë¼ì„ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì‚¬ê³ ê°œìš”ì™€ ì¬ë°œë°©ì§€ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'íƒ€ì›Œí¬ë ˆì¸ ì„¤ì¹˜Â·í•´ì²´ ì‘ì—…ì—ì„œ ë°œìƒí•œ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì£¼ìš” ì›ì¸ê³¼ ì˜ˆë°©ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ë°€íê³µê°„(ë§¨í™€, íƒ±í¬ ë‚´ë¶€ ë“±) ì§ˆì‹ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì‘ì—… ì „Â·ì¤‘Â·í›„ ì•ˆì „ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ì»¨ë² ì´ì–´ ë¼ì¸ í˜‘ì°© ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì„¤ë¹„ê°œì„  ë° ì‘ì—…ì ˆì°¨ ê°œì„ ë°©ì•ˆì„ ì œì•ˆí•´ì¤˜.',
    'ê³ ì†Œì‘ì—…ëŒ€ ì‚¬ìš© ì¤‘ ì¶”ë½ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ë³´í˜¸êµ¬Â·ì‘ì—…ë°œíŒÂ·ì•ˆì „ëŒ€ ê´€ë ¨ ì˜ˆë°©ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ë¹„ê³„(ë™ë°”ë¦¬ í¬í•¨) ë¶•ê´´Â·ì¶”ë½ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  êµ¬ì¡°ì  ê²°í•¨, ì‘ì—…ë°œíŒ ì„¤ì¹˜ ë¶ˆëŸ‰ ë“± ì£¼ìš” ì›ì¸ê³¼ ê´€ë¦¬ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ì „ê¸°íŒë„¬Â·ë¶„ì „ë°˜ ì‘ì—… ì¤‘ ê°ì „ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì ê¸ˆÂ·í‘œì‹œ(LOTO), ì ˆì—°ë³´í˜¸êµ¬, ì ê²€ì ˆì°¨ ì¤‘ì‹¬ìœ¼ë¡œ ì˜ˆë°©ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ë„ì¥Â·ì„¸ì²™ ì‘ì—…ì¥ì—ì„œì˜ í™”ì¬Â·í­ë°œ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì¸í™”ì„± ë¬¼ì§ˆ ê´€ë¦¬, í†µí’Â·í™˜ê¸°, ì í™”ì› ê´€ë¦¬ ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'í”„ë ˆìŠ¤Â·ì „ë‹¨ê¸° ë“± ê¸°ê³„ì— ì˜í•œ ì ˆë‹¨Â·ë¼ì„ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ë°©í˜¸ì¥ì¹˜, ì–‘ìˆ˜ì¡°ì‘, ì‘ì—…í‘œì¤€ì„œ ê°œì„ ë°©ì•ˆì„ ì •ë¦¬í•´ì¤˜.',
    'ì²œì¥í¬ë ˆì¸Â·í˜¸ì´ìŠ¤íŠ¸ ì‚¬ìš© ì¤‘ ì¶©ëŒÂ·ë‚™í•˜ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì™€ì´ì–´ë¡œí”„ ì ê²€, ì •ê²©í•˜ì¤‘ ì¤€ìˆ˜, ì‹ í˜¸ìˆ˜ ë°°ì¹˜ ë“± ì˜ˆë°©ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ì´ë™ì‹ ì‚¬ë‹¤ë¦¬ ì‚¬ìš© ì¤‘ ì¶”ë½ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì„¤ì¹˜ ê°ë„, ë¯¸ë„ëŸ¼ ë°©ì§€, ìƒë¶€ ì§€ì§€ ë°©ë²• ë“± ì•ˆì „ìˆ˜ì¹™ ì¤‘ì‹¬ìœ¼ë¡œ ì˜ˆë°©ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'êµ´ì°©(í™ë§‰ì´Â·íŠ¸ë Œì¹˜) ì‘ì—… ì¤‘ í† ì‚¬ ë¶•ê´´ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  í™ë§‰ì´ êµ¬ì¡°, ë¶•ê´´ ì§•í›„ ê´€ë¦¬, ì¶œì…í†µì œ ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'íœ´ëŒ€ìš© ì ˆë‹¨ê¸°Â·ê·¸ë¼ì¸ë” ì‚¬ìš© ì¤‘ ë¹„ì‚°Â·ë² ì„ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì—°ë§ˆì„ íŒŒì†, ë³´í˜¸êµ¬ ì°©ìš©, ì‘ì—…ìì„¸ ê°œì„ ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ìš©ì ‘Â·ìš©ë‹¨ ì‘ì—… ì¤‘ í™”ì¬Â·í­ë°œ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ê°€ì—°ë¬¼ ê´€ë¦¬, ë¶ˆí‹°ë¹„ì‚° ë°©ì§€, ê°€ìŠ¤ëˆ„ì¶œ ì ê²€ ì ˆì°¨ ë“±ì„ ì •ë¦¬í•´ì¤˜.',
    'ì‚°Â·ì•Œì¹¼ë¦¬ ë“± í™”í•™ë¬¼ì§ˆ ëˆ„ì¶œÂ·í”¼ë¶€Â·ëˆˆ í™”ìƒ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ë³´ê´€Â·ì´ì†¡Â·ì£¼ì… ì‘ì—… ë‹¨ê³„ë³„ ì˜ˆë°©ëŒ€ì±…ê³¼ ë¹„ìƒì¡°ì¹˜ ë°©ì•ˆì„ ì •ë¦¬í•´ì¤˜.',
    'ì‚°ì—…ìš© ë¡œë´‡Â·ìë™í™”ì„¤ë¹„ ì£¼ë³€ì—ì„œ ë°œìƒí•œ í˜‘ì°©Â·ì¶©ëŒ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì•ˆì „íœìŠ¤, ì¸í„°ë¡, ì•ˆì „ì„¼ì„œ ì ìš©ë°©ì•ˆì„ ì •ë¦¬í•´ì¤˜.',
    'í•˜ì—­ì‘ì—…(ìƒÂ·í•˜ì°¨, íŒ”ë ˆíŠ¸ ì´ë™ ë“±) ì¤‘ ë¼ì„Â·ì¶”ë½ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì‘ì—…ë™ì„  ì •ë¦¬, í•˜ì—­ì¥ êµ¬ì¡°ê°œì„ , ì‹ í˜¸Â·ìœ ë„ì²´ê³„ ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ì´ë™ì‹ í¬ë ˆì¸(ì¹´ê³ í¬ë ˆì¸ í¬í•¨) ì „ë„Â·ì ‘ì´‰ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì§€ë°˜ì¹¨í•˜, ì•„ì›ƒíŠ¸ë¦¬ê±° ì„¤ì¹˜, ì „ì„  ì ‘ì´‰ ìœ„í—˜ ì¤‘ì‹¬ìœ¼ë¡œ ì˜ˆë°©ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ì§‘ìˆ˜ì •Â·íìˆ˜ì²˜ë¦¬ì¥ ë“±ì—ì„œ í™©í™”ìˆ˜ì†ŒÂ·ìœ í•´ê°€ìŠ¤ì— ì˜í•œ ì§ˆì‹ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ê°€ìŠ¤ë†ë„ ì¸¡ì •, í™˜ê¸°, ê°ì‹œì¸ ë°°ì¹˜ ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
    'ê²¨ìš¸ì²  ê²°ë¹™ëœ ì‘ì—…ì¥ ë°”ë‹¥ì—ì„œ ë¯¸ë„ëŸ¬ì§Â·ë„˜ì–´ì§ ì‚¬ê³ ì‚¬ë¡€ë¥¼ ì°¾ì•„ì£¼ê³  ì œì„¤Â·ì œë¹™, ë°°ìˆ˜ ê°œì„ , ë¯¸ë„ëŸ¼ ë°©ì§€êµ¬ ì„¤ì¹˜ ë“± ì˜ˆë°©ëŒ€ì±…ì„ ì •ë¦¬í•´ì¤˜.',
  ];
  
  function pickRandomHints(source: string[], count: number): string[] {
    const arr = [...source];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr.slice(0, Math.min(count, arr.length));
  }

  const onKey = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const chooseType = (id: string) => {
    Cookies.set('selectedJobType', id, { expires: 7 });
    setSelectedJobType(id);
    setShowTypeModal(false);
  };

  const cur =
    TYPE_META[selectedJobType ?? ''] ?? { label: 'ë¶„ì•¼ ì„ íƒ', emoji: 'ğŸ’¼' };

  const currentTaskMeta = selectedTask ? TASK_META[selectedTask] : null;

  const [isDocCreateMode, setIsDocCreateMode] = useState(false);

  const isSafetyDocTask = isDocCreateMode;

  // HTML -> í…ìŠ¤íŠ¸ (ë°±ì—…ìš©)
  const htmlToText = (html: string) => {
    try {
      const clean = html.replace(/<br\s*\/?>/gi, '\n');
      const doc = new DOMParser().parseFromString(clean, 'text/html');
      return (doc.body.textContent || '').replace(/\u00A0/g, ' ').trim();
    } catch {
      return html
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/<\/?[^>]+>/g, '')
        .trim();
    }
  };

  const copyToClipboard = async (text: string) => {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      }
      setCopied(true);
      setTimeout(() => setCopied(false), 1200);
    } catch {
      // ignore
    }
  };

  const handleCopy = async (idx: number, fallbackHtml: string) => {
    const el = contentRefs.current[idx];
    const text = el?.innerText?.trim() || htmlToText(fallbackHtml);
    if (text) await copyToClipboard(text);
  };

  const handleRegenerate = (idx: number) => {
    const upperUser = [...messages]
      .slice(0, idx)
      .reverse()
      .find((m) => m.role === 'user');
    const fallbackUser = [...messages]
      .reverse()
      .find((m) => m.role === 'user');
    const q = htmlToText(upperUser?.content || fallbackUser?.content || '');
    if (!q) return;
    setMessages(messages.filter((_, i) => i !== idx));
    regenerate(q);
  };

  const cutHtmlBeforeEvidence = (html: string) => {
    if (!html) return html;

    // <br> â†’ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë°”ê¿”ì„œ ì¤„ ë‹¨ìœ„ë¡œ í—¤ë”ë¥¼ ì°¾ê¸° ì‰½ê²Œ
    const working = html.replace(/<(br|BR)\s*\/?>/g, '\n');

    // 1) "2) ê·¼ê±°" ìœ„ì¹˜
    const evidenceRe = /^\s*(?:2\)|2\.|â‘¡)\s*ê·¼ê±°\s*$/m;
    const evidenceMatch = working.match(evidenceRe);

    // 2) "5) ì°¸ê³  ì‚¬ê³ ì‚¬ë¡€" ìœ„ì¹˜
    const accidentRe = /^\s*5\)\s*ì°¸ê³ \s*ì‚¬ê³ ì‚¬ë¡€\s*$/m;
    const accidentMatch = working.match(accidentRe);

    let cutIdx = -1;

    if (evidenceMatch?.index != null) {
      cutIdx = evidenceMatch.index;
    }
    if (accidentMatch?.index != null) {
      // ê·¼ê±°/ì‚¬ê³ ì‚¬ë¡€ ë‘˜ ë‹¤ ìˆìœ¼ë©´ ë” ì•ì— ë‚˜ì˜¤ëŠ” ìª½ì—ì„œ ìë¥´ê¸°
      cutIdx =
        cutIdx === -1
          ? accidentMatch.index
          : Math.min(cutIdx, accidentMatch.index);
    }

    // 3) í˜¹ì‹œ ì •ê·œì‹ì´ ì•ˆ ë¨¹íˆëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ fallback
    if (cutIdx < 0) {
      const accIdx = working.indexOf('5) ì°¸ê³  ì‚¬ê³ ì‚¬ë¡€');
      if (accIdx >= 0) cutIdx = accIdx;
    }

    // 4) ì˜ˆì „ì²˜ëŸ¼ ğŸ”— ì•„ì´ì½˜ ê¸°ì¤€ fallback ìœ ì§€
    if (cutIdx < 0) {
      const altIconIdx = working.indexOf('ğŸ”—');
      if (altIconIdx >= 0) cutIdx = altIconIdx;
    }

    // ìë¥¼ ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ ì›ë³¸ ê·¸ëŒ€ë¡œ
    if (cutIdx <= 0) return html;

    const before = working.slice(0, cutIdx);
    return before.replace(/\n/g, '<br />');
  };

  const splitDigestForArticles = (digest: string, marker = 'ì°¸ê³  ê¸°ì‚¬ ëª©ë¡') => {
    if (!digest) return { summaryText: '', articlesText: '' };
  
    const idx = digest.indexOf(marker);
  
    if (idx === -1) {
      return {
        summaryText: digest.trim(),
        articlesText: '',
      };
    }
  
    const summaryPart = digest.slice(0, idx);
    const articlesPart = digest.slice(idx);
  
    return {
      summaryText: summaryPart.trim(),
      articlesText: articlesPart.trim(),
    };
  };
  

  const isSafetyNewsHtml = (html: string) => {
    return html.includes('data-msg-type="safety-news"');
  };

  // ğŸ”¹ ì¶”ê°€: ì‚¬ê³ ì‚¬ë¡€ ì„¹ì…˜ì´ ìˆëŠ”ì§€ ì²´í¬
  const hasAccidentCasesInHtml = (html: string) => {
    if (!html) return false;

    // ëŒ€í‘œ íŒ¨í„´ë“¤
    if (html.includes('5) ì°¸ê³  ì‚¬ê³ ì‚¬ë¡€')) return true;
    if (html.includes('ì°¸ê³  ì‚¬ê³ ì‚¬ë¡€')) return true;
    if (/\[ì‚¬ê³ ì‚¬ë¡€\s*\d+\]/.test(html)) return true;

    return false;
  };

  const extractSafetySummaryHtml = (html: string) => {
    const match = html.match(
      /<div[^>]+data-section="summary"[^>]*>([\s\S]*?)<\/div>/,
    );
    if (!match) {
      return cutHtmlBeforeEvidence(html);
    }
    return match[0];
  };

  const extractSafetyArticlesHtml = (html: string) => {
    const match = html.match(
      /<div[^>]+data-section="articles"[^>]*>([\s\S]*?)<\/div>/,
    );
    if (!match) return '';
    const cleaned = match[0].replace(/display\s*:\s*none\s*;?/i, '');
    return `<div><h3>ì°¸ê³  ê¸°ì‚¬ ëª©ë¡</h3>${cleaned}</div>`;
  };

  // ğŸ”¹ ìƒˆë¡œ ì¶”ê°€: ì…ë²•ì˜ˆê³  ìš”ì•½ ë©”ì‹œì§€ì¸ì§€ íŒë³„
  const isNoticeSummaryHtml = (html: string) => {
    return html.includes('data-msg-type="notice-summary"');
  };

  // ğŸ”¹ ìƒˆë¡œ ì¶”ê°€: ì…ë²•ì˜ˆê³  ë©”ì‹œì§€ì—ì„œ "ì°¸ê³  ì…ë²•ì˜ˆê³  ëª©ë¡" ì„¹ì…˜ë§Œ ì œê±°í•œ ë³¸ë¬¸
  const extractNoticeSummaryHtml = (html: string) => {
    // data-section="articles" ë¸”ë¡ë§Œ ë‚ ë¦¬ê³  ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
    return html.replace(
      /<div[^>]+data-section="articles"[^>]*>[\s\S]*?<\/div>/,
      '',
    );
  };

  // ğŸ”¹ ìƒˆë¡œ ì¶”ê°€: "ì°¸ê³  ì…ë²•ì˜ˆê³  ëª©ë¡"ì„ ì œëª© + URL ë§í¬ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
  const extractNoticeArticlesHtml = (html: string) => {
    const match = html.match(
      /<div[^>]+data-section="articles"[^>]*>([\s\S]*?)<\/div>/,
    );
    if (!match) return '';

    // ì•ˆìª½ HTML -> í…ìŠ¤íŠ¸ ë¼ì¸
    const inner = match[1]
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<\/?[^>]+>/g, '')
      .trim();

    if (!inner) return '';

    const lines = inner
      .split('\n')
      .map((l) => l.trim())
      .filter(Boolean);

    const items: { title: string; url: string }[] = [];

    for (const line of lines) {
      if (line.startsWith('ì°¸ê³  ì…ë²•ì˜ˆê³  ëª©ë¡')) continue;

      // ì˜ˆ:
      // 1. ì œëª© (ì…ë²•ì˜ˆê³ ê¸°ê°„: 2025-10-02~2025-11-11, URL: https://www.moleg....)
      const m = line.match(
        /^\d+\.\s*(.+?)\s*\((?:ì…ë²•ì˜ˆê³ ê¸°ê°„:[^,]*,)?\s*URL:\s*([^)]+)\)/,
      );
      if (m) {
        items.push({
          title: m[1].trim(),
          url: m[2].trim(),
        });
      }
    }

    // íŒŒì‹± ì‹¤íŒ¨í•˜ë©´ ê·¸ëƒ¥ ì›ë¬¸ì´ë¼ë„ ë³´ì—¬ì£¼ê¸°
    if (!items.length) {
      const fallback = lines.join('<br />');
      return `<div><h3>ì°¸ê³  ì…ë²•ì˜ˆê³  ëª©ë¡</h3><div>${fallback}</div></div>`;
    }

    const listHtml = items
      .map(
        (it) =>
          `<li><a href="${it.url}" target="_blank" rel="noopener noreferrer">${it.title}</a></li>`,
      )
      .join('');

    return `<div><h3>ì°¸ê³  ì…ë²•ì˜ˆê³  ëª©ë¡</h3><ul>${listHtml}</ul></div>`;
  };


  const handleSend = () => {
    // ë‚´ìš©ë„ íŒŒì¼ë„ ì—†ìœ¼ë©´ ë¬´ì‹œ (ì„ íƒ ì‚¬í•­)
    if (!input.trim() && attachments.length === 0) return;
  
    // ğŸ”’ 1) ê²ŒìŠ¤íŠ¸ ì œí•œ ì²´í¬ (ì¿ í‚¤ ê¸°ì¤€)
    if (shouldBlockGuestByLimit()) {
      setShowLoginModal(true);
      return; // ì—¬ê¸°ì„œ ë°”ë¡œ ë§‰ì•„ì•¼ /api ìš”ì²­ ì•ˆ ë‚˜ê°
    }
  
    // ğŸ”’ 2) ì‹¤ì œë¡œ ë³´ë‚¼ ê±°ë©´ ì¿ í‚¤ ì¹´ìš´íŠ¸ ì¦ê°€ (ê²ŒìŠ¤íŠ¸ë§Œ)
    if (!user) {
      const prev = getGuestMsgCountFromCookie();
      setGuestMsgCountToCookie(prev + 1);
    }
  
    // ì´í•˜ ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ
    setActiveHintTask(null);
    setActiveHints([]);
  
    sendMessage({
      taskType: selectedTask || undefined,
      files: attachments,
    });
  
    setShowLanding(false);
    setSelectedTask(null);
    setAttachments([]);
  };
  

  const handleDragOver = (e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
  };

  const handleDrop = (e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    if (!e.dataTransfer?.files?.length) return;
    const files = Array.from(e.dataTransfer.files);
    setAttachments((prev) => [...prev, ...files]);
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files ? Array.from(e.target.files) : [];
    if (!files.length) return;
    setAttachments((prev) => [...prev, ...files]);
    e.target.value = '';
  };

  const fetchWeeklySafetyNews = async () => {
    try {
      const params = new URLSearchParams();

      if (selectedJobType === 'environment' || selectedJobType === 'infosec') {
        params.set('category', selectedJobType);
      }

      const qs = params.toString();
      const url = `/api/safety-news/latest${qs ? `?${qs}` : ''}`;

      const res = await fetch(url, { method: 'GET', cache: 'no-store' });

      if (!res.ok) {
        console.error('[ChatArea] safety-news error status:', res.status);
        const errorMsg: ChatMessage = {
          role: 'assistant',
          content:
            'ê¸ˆì£¼ì˜ ì•ˆì „ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.',
        };
        setMessages([...messages, errorMsg]);
        setShowLanding(false);
        return;
      }

      const data = (await res.json()) as SafetyNewsResponse;

      const periodText =
        (data.period && data.period.trim()) ||
        (data.batch_date && data.batch_date.slice(0, 10)) ||
        '';

      const titleHtml = periodText
        ? `ğŸ”” <strong>${periodText} ê¸ˆì£¼ì˜ ì•ˆì „ ë‰´ìŠ¤</strong>`
        : 'ğŸ”” <strong>ê¸ˆì£¼ì˜ ì•ˆì „ ë‰´ìŠ¤</strong>';

      const metaParts: string[] = [];

      if (data.category && TYPE_META[data.category]) {
        const meta = TYPE_META[data.category];
        metaParts.push(`${meta.emoji} ${meta.label}`);
      }

      if (typeof data.source_count === 'number') {
        metaParts.push(`ê¸°ì‚¬ ${data.source_count}ê±´ ê¸°ì¤€`);
      }

      const metaHtml = metaParts.length
        ? `<div style="margin-top:4px; font-size:12px; opacity:0.8;">
             ${metaParts.join(' Â· ')}
           </div>`
        : '';

      const digestText = data.digest || '';
      const { summaryText, articlesText } = splitDigestForArticles(digestText);

      const summaryHtml = summaryText
        ? summaryText
            .split('\n')
            .map((line) => line.trim())
            .filter(Boolean)
            .join('<br />')
        : '';

      const articlesHtml = articlesText
        ? articlesText
            .split('\n')
            .map((line) => line.trim())
            .filter(Boolean)
            .join('<br />')
        : '';

      const html = `
        <div data-msg-type="safety-news">
          <p>${titleHtml}</p>
          ${metaHtml}
          ${
            summaryHtml
              ? `<div style="margin-top:8px;" data-section="summary">${summaryHtml}</div>`
              : ''
          }
          ${
            articlesHtml
              ? `<div style="margin-top:12px; display:none;" data-section="articles">${articlesHtml}</div>`
              : ''
          }
        </div>
      `;

      const newsMsg: ChatMessage = {
        role: 'assistant',
        content: html,
      };

      setMessages([...messages, newsMsg]);
      setShowLanding(false);
    } catch (e) {
      console.error('[ChatArea] safety-news fetch error:', e);
      const errorMsg: ChatMessage = {
        role: 'assistant',
        content: 'ê¸ˆì£¼ì˜ ì•ˆì „ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      };
      setMessages([...messages, errorMsg]);
      setShowLanding(false);
    }
  };

  const fetchLawNoticeSummary = async () => {
    try {
      const res = await fetch('/api/expect-law/latest');
  
      if (!res.ok) {
        console.error('[ChatArea] law-notice-summary error status:', res.status);
        const errorMsg: ChatMessage = {
          role: 'assistant',
          content:
            'ì…ë²• ì˜ˆê³  ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.',
        };
        setMessages([...messages, errorMsg]);
        setShowLanding(false);
        return;
      }
  
      const data = (await res.json()) as LawNoticeSummaryResponse;
      console.log('[ChatArea] expect-law data =', data);
  
      const cutoff = data.cutoff_date?.slice(0, 10);
      const run = data.run_date?.slice(0, 10);
  
      const periodText =
        cutoff && run ? `${cutoff} ~ ${run}` : run || cutoff || '';
  
      const titleHtml = periodText
        ? `ğŸ“œ <strong>${periodText} ì…ë²• ì˜ˆê³  ìš”ì•½</strong>`
        : 'ğŸ“œ <strong>ì…ë²• ì˜ˆê³  ìš”ì•½</strong>';
  
      const metaParts: string[] = [];
  
      if (typeof data.months_back === 'number') {
        metaParts.push(`ìµœê·¼ ${data.months_back}ê°œì›” ê¸°ì¤€`);
      }
  
      if (typeof data.item_count === 'number') {
        metaParts.push(`ì…ë²•ì˜ˆê³  ${data.item_count}ê±´ ê¸°ì¤€`);
      }
  
      const metaHtml = metaParts.length
        ? `<div style="margin-top:4px; font-size:12px; opacity:0.8;">
             ${metaParts.join(' Â· ')}
           </div>`
        : '';
  
      const digestText =
        data.digest || data.summary_kor || data.text?.summary_kor || '';
  
      // âœ… ì—¬ê¸°ì„œ marker ë¥¼ 'ì°¸ê³  ì…ë²•ì˜ˆê³  ëª©ë¡' ìœ¼ë¡œ
      const { summaryText, articlesText } = splitDigestForArticles(
        digestText,
        'ì°¸ê³  ì…ë²•ì˜ˆê³  ëª©ë¡',
      );
  
      const summaryHtml = summaryText
        ? summaryText
            .split('\n')
            .map((line) => line.trim())
            .filter(Boolean)
            .join('<br />')
        : '';
  
      const articlesHtml = articlesText
        ? articlesText
            .split('\n')
            .map((line) => line.trim())
            .filter(Boolean)
            .join('<br />')
        : '';
  
      // ğŸ”¥ summary / articles ë¥¼ data-section ìœ¼ë¡œ ë‚˜ëˆ„ê³ 
      //    articles ëŠ” display:none ìœ¼ë¡œ ìˆ¨ê²¨ë‘”ë‹¤ (ìš°ì¸¡ íŒ¨ë„ìš©)
      const html = `
        <div data-msg-type="notice-summary">
          <p>${titleHtml}</p>
          ${metaHtml}
          ${
            summaryHtml
              ? `<div style="margin-top:8px;" data-section="summary">${summaryHtml}</div>`
              : ''
          }
          ${
            articlesHtml
              ? `<div style="margin-top:12px; display:none;" data-section="articles">${articlesHtml}</div>`
              : ''
          }
        </div>
      `;
  
      const msg: ChatMessage = {
        role: 'assistant',
        content: html,
      };
  
      setMessages([...messages, msg]);
      setShowLanding(false);
    } catch (e) {
      console.error('[ChatArea] expect-law-summary fetch error:', e);
      const errorMsg: ChatMessage = {
        role: 'assistant',
        content: 'ì…ë²• ì˜ˆê³  ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      };
      setMessages([...messages, errorMsg]);
      setShowLanding(false);
    }
  };
  

  const handleQuickActionClick = (action: QuickAction) => {
    setIsDocCreateMode(false);

    if (action.taskType) {
      setSelectedTask(action.taskType);
    }

    if (action.id === 'today_accident') {
      setActiveHintTask(null);
      setActiveHints([]);
      fetchWeeklySafetyNews();
      return;
    }

    // ğŸ”¹ ì¶”ê°€: ì…ë²• ì˜ˆê³  ìš”ì•½
    if (action.id === 'notice_summary') {
      setActiveHintTask(null);
      setActiveHints([]);
      fetchLawNoticeSummary();
      return;
    }

    if (action.id === 'accident_search') {
      const intro: ChatMessage = {
        role: 'assistant',
        content: ACCIDENT_INTRO_TEXT,
      };
  
      if (messages.length === 0) {
        setMessages([intro]);
      } else {
        setMessages([...messages, intro]);
      }
  
      setActiveHintTask('accident_search');
      setActiveHints(pickRandomHints(ACCIDENT_HINTS, 3)); // ğŸ”¹ ëœë¤ 3ê°œ
  
      setInput('');
      const el = document.querySelector<HTMLInputElement>('.chat-input');
      if (el) el.focus();
  
      return;
    }

    if (action.id === 'doc_review') {
      const intro: ChatMessage = {
        role: 'assistant',
        content: DOC_REVIEW_INTRO_TEXT,
      };

      if (messages.length === 0) {
        setMessages([intro]);
      } else {
        setMessages([...messages, intro]);
      }

      setActiveHintTask(null);
      setActiveHints([]);

      setInput('');
      const el = document.querySelector<HTMLInputElement>('.chat-input');
      if (el) el.focus();

      return;
    }

    // âœ… ì•ˆì „ ë¬¸ì„œ ìƒì„±: ë§í’ì„ /ì¹© ì—†ì´ íŒ¨ë„ë§Œ ë³´ì—¬ì£¼ê¸°
    if (action.id === 'doc_create') {
      setActiveHintTask(null);
      setActiveHints([]);
      setIsDocCreateMode(true);          // <-- ì—¬ê¸°ì„œ íŒ¨ë„ ON

      setInput('');
      const el = document.querySelector<HTMLInputElement>('.chat-input');
      if (el) el.focus();
      return;
    }

    if (
      action.id === 'law_interpret' ||
      action.id === 'guideline_interpret' ||
      action.id === 'edu_material'
    ) {
      let hintTask: HintTask;
      let introText: string;
      let pool: string[];

      if (action.id === 'law_interpret') {
        hintTask = 'law_interpret';
        introText = LAW_INTRO_TEXT;
        pool = LAW_INTERPRET_HINTS;
      } else if (action.id === 'guideline_interpret') {
        hintTask = 'guideline_interpret';
        introText = GUIDELINE_INTRO_TEXT;
        pool = GUIDELINE_HINTS;
      } else {
        hintTask = 'edu_material';
        introText = EDU_INTRO_TEXT;
        pool = EDU_MATERIAL_HINTS;
      }

      const intro: ChatMessage = {
        role: 'assistant',
        content: introText,
      };

      if (messages.length === 0) {
        setMessages([intro]);
      } else {
        setMessages([...messages, intro]);
      }

      if (action.id === 'edu_material') {
        setActiveHints(pool);
      } else {
        setActiveHints(pickRandomHints(pool, 3));
      }

      setActiveHintTask(hintTask);

      setInput('');
      const el = document.querySelector<HTMLInputElement>('.chat-input');
      if (el) el.focus();

      return;
    }

    setActiveHintTask(null);
    setActiveHints([]);

    setInput(action.placeholder);
    const el = document.querySelector<HTMLInputElement>('.chat-input');
    if (el) el.focus();
  };

  const handleHintClick = (task: HintTask, hint: string) => {
    // ğŸ”’ 1) ê²ŒìŠ¤íŠ¸ ì œí•œ ì²´í¬
    if (shouldBlockGuestByLimit()) {
      setShowLoginModal(true);
      return;
    }

    // ğŸ”’ 2) ì¿ í‚¤ ì¹´ìš´íŠ¸ +1
    if (!user) {
      const prev = getGuestMsgCountFromCookie();
      setGuestMsgCountToCookie(prev + 1);
    }
  
    let mappedTaskType: TaskType;
    if (task === 'doc_create') {
      mappedTaskType = 'doc_review';
    } else if (task === 'edu_material') {
      mappedTaskType = 'edu_material';
    } else if (task === 'guideline_interpret') {
      mappedTaskType = 'guideline_interpret';
    } else if (task === 'accident_search') {   
      mappedTaskType = 'accident_search';
    } else {
      mappedTaskType = 'law_interpret';
    }
  
    setSelectedTask(mappedTaskType);
  
    sendMessage({
      taskType: mappedTaskType,
      overrideMessage: hint,
    });
  
    setActiveHintTask(null);
    setActiveHints([]);
  };  

  
  const handleSelectSafetyDoc = (category: any, doc: any) => {
    // ì‘ì—… íƒ€ì…ì„ ë¬¸ì„œ ìƒì„±/ê²€í†  ìª½ìœ¼ë¡œ ì„¤ì •
    setSelectedTask('doc_review');
    // ë¬¸ì„œ ì„ íƒ íŒ¨ë„ ë‹«ê¸°
    setIsDocCreateMode(false);

    // 1) ì‚¬ìš©ì ë§í’ì„ : ë¬¸ì„œ ì´ë¦„ë§Œ ê¹”ë”í•˜ê²Œ
    const userMsg: ChatMessage = {
      role: 'user',
      content: doc.label, // ì˜ˆ: "ë¹„ìƒì‚¬íƒœ ëŒ€ì‘í›ˆë ¨ ê²°ê³¼ë³´ê³ ì„œ"
    };

    // 2) ë¬¸ì„œë³„ ì•ˆë‚´ ê°€ì´ë“œ ì°¾ê¸°
    const guide = SAFETY_DOC_GUIDES[doc.id];

    const intro =
      guide?.intro ||
      `"${doc.label}" ë¬¸ì„œë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ì •ë³´ë¥¼ ì •ë¦¬í•´ ì£¼ì„¸ìš”.`;

    const fields =
      guide?.fields && guide.fields.length > 0
        ? guide.fields
        : [
            'ë¬¸ì„œì˜ ëª©ì ê³¼ ì‘ì„± ë°°ê²½',
            'ì ìš© ëŒ€ìƒ(ì‚¬ì—…ì¥, ê³µì •, ì¸ì› ë“±)',
            'ë¬¸ì„œì— í¬í•¨í•˜ê³  ì‹¶ì€ ì£¼ìš” í•­ëª©',
          ];

    const fieldsHtml = fields.map((f) => `<li>${f}</li>`).join('');

    const downloadHtml =
      guide?.downloadLabel
        ? `
        <div style="margin-top:12px;">
          <a
            href="${guide.downloadUrl || '#'}"
            target="_blank"
            rel="noopener"
            class="safety-doc-download-chip"
          >
            ğŸ“„ ${guide.downloadLabel}
          </a>
        </div>
      `
        : '';

    const assistantHtml = `
      <p>${intro}</p>
      <ul>
        ${fieldsHtml}
      </ul>
      ${downloadHtml}
    `;

    const aiMsg: ChatMessage = {
      role: 'assistant',
      content: assistantHtml,
    };

    // 3) ë©”ì‹œì§€ ìŠ¤íƒì— user â†’ assistant ìˆœì„œë¡œ ì¶”ê°€
    setMessages([...messages, userMsg, aiMsg]);

    setInput('');
    const el = document.querySelector<HTMLInputElement>('.chat-input');
    if (el) el.focus();
  };



  // âœ… í˜„ì¬ê¹Œì§€ user role ë©”ì‹œì§€ ê°œìˆ˜
  const getUserMessageCount = () =>
    messages.filter((m) => m.role === 'user').length;

  // âœ… ê²ŒìŠ¤íŠ¸ ì œí•œ ì²´í¬ (3ê°œ ì´ìƒì´ë©´ true)
  const shouldBlockGuestByLimit = () => {
    // ë¡œê·¸ì¸ í–ˆìœ¼ë©´ ì œí•œ ì—†ìŒ
    if (user) return false;
  
    const count = getGuestMsgCountFromCookie(); // ì§€ê¸ˆê¹Œì§€ ì¿ í‚¤ì— ì €ì¥ëœ íšŸìˆ˜
    const nextCount = count + 1;               // ì´ë²ˆì— ë³´ë‚´ë ¤ëŠ” ê²ƒê¹Œì§€ í¬í•¨
  
    console.log('[guest-limit]', { count, nextCount });
  
    // 3ë²ˆê¹Œì§€ í—ˆìš©, 4ë²ˆì§¸ë¶€í„° ë§‰ê¸°
    return nextCount > GUEST_LIMIT;
  };

  useEffect(() => {
    const saved = Cookies.get('selectedJobType') as string | undefined;
    if (saved) {
      setSelectedJobType(saved);
      setShowTypeModal(false);
    } else {
      setShowTypeModal(true);
    }
  }, [setSelectedJobType]);

  useEffect(() => {
    if (typeof window === 'undefined') return;
    if (bootOnce.current) return;

    const sp = new URLSearchParams(window.location.search);
    const sharedId = sp.get('id') || sp.get('job_id');
    if (!sharedId) return;

    bootOnce.current = true;

    (async () => {
      try {
        const res = await fetch(
          `/api/public-answer?id=${encodeURIComponent(sharedId)}`,
          { cache: 'no-store' },
        );

        if (!res.ok) {
          setMessages([
            {
              role: 'assistant',
              content:
                'ê³µìœ ëœ ë‹µë³€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë§í¬ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ëœ IDì¼ ìˆ˜ ìˆì–´ìš”.',
            },
          ]);
          return;
        }

        const data = (await res.json()) as {
          job_id: string;
          category?: 'environment' | 'infosec' | string;
          question?: string;
          answer_html?: string;
          created_at?: string;
        };

        const question = (data.question || '').trim();
        const answerHtml = (data.answer_html || '').trim();

        if (
          data.category &&
          (data.category === 'environment' || data.category === 'infosec')
        ) {
          Cookies.set('selectedJobType', data.category, { expires: 7 });
          setSelectedJobType(data.category);
        }

        const initialMsgs: {
          role: 'user' | 'assistant';
          content: string;
        }[] = [];
        if (question)
          initialMsgs.push({ role: 'user', content: question });
        else
          initialMsgs.push({
            role: 'user',
            content: '(ê³µìœ  ë§í¬ë¡œ ë¶ˆëŸ¬ì˜¨ ì§ˆë¬¸)',
          });

        if (answerHtml)
          initialMsgs.push({ role: 'assistant', content: answerHtml });
        else
          initialMsgs.push({
            role: 'assistant',
            content: 'ë‹µë³€ ë³¸ë¬¸ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.',
          });

        setMessages(initialMsgs);
      } catch (e) {
        console.error('[ChatArea] public/answer fetch error:', e);
        setMessages([
          {
            role: 'assistant',
            content: 'ê³µìœ ëœ ë‹µë³€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
          },
        ]);
      }
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    if (messages.length === 0) {
      setActiveHintTask(null);
      setActiveHints([]);
    }
  }, [messages.length]);

  return (
    <>
      <section className={s.wrap}>
        {/* Header */}
        <div className={s.header}>
          <div className={s.headerLeft}>
            <div className={s.productName}>REG AI</div>
            <div className={s.chatTitle}>
              {messages.length > 0 && messages[0].role === 'user'
                ? htmlToText(messages[0].content).slice(0, 24) || 'ìƒˆ ëŒ€í™”'
                : 'ìƒˆ ëŒ€í™”'}
            </div>
          </div>

          <div className={s.headerRight}>
            {/* ë¡œê·¸ì¸ ì‹œ: ê³„ì • ë“œë¡­ë‹¤ìš´ / ë¹„ë¡œê·¸ì¸ ì‹œ: ë¡œê·¸ì¸ ë²„íŠ¼ */}
            {user ? (
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    variant="outline"
                    size="sm"
                    className={s.settingsBtn}
                    onClick={handleAccountButtonClick}
                  >
                    <User2 className={s.iconXs} />
                    <span className={s.accountLabel}>
                      {user.email ?? 'ê³„ì •'}
                    </span>
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuLabel>ë‚´ ê³„ì •</DropdownMenuLabel>
                  {user.email && (
                    <DropdownMenuItem disabled>
                      {user.email}
                    </DropdownMenuItem>
                  )}
                  <DropdownMenuSeparator />
                  <DropdownMenuItem onClick={handleLogout}>
                    <LogOut className={s.iconXs} />
                    <span>ë¡œê·¸ì•„ì›ƒ</span>
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            ) : (
              <Button
                variant="outline"
                size="sm"
                className={s.settingsBtn}
                onClick={() => setShowLoginModal(true)}
              >
                <Settings className={s.iconXs} />
                ë¡œê·¸ì¸
              </Button>
            )}
          </div>
        </div>

        {/* Body */}
        <div className={s.body}>
          <div className={s.stream}>
            <div className={s.streamInner}>
              {messages.length === 0 && (
                <>
                  {isSafetyDocTask ? (
                    // âœ… "ì•ˆì „ ë¬¸ì„œ ìƒì„±" ì„ íƒ ì‹œ: ì²« ë²ˆì§¸ ìŠ¤ìƒ·ì²˜ëŸ¼ ì¹´í…Œê³ ë¦¬/ë“œë¡­ë‹¤ìš´ UI
                    <MakeSafetyDocs
                      onSelectDoc={(category, doc) => {
                        handleSelectSafetyDoc(category, doc);
                      }}
                    />
                  ) : (
                    // ê·¸ ì™¸ ì‘ì—…ë“¤ì€ ê¸°ì¡´ "ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?" í€µ ì•¡ì…˜ ë…¸ì¶œ
                    <div className={s.quickWrap}>
                      <div className={s.quickTitle}>ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>

                      {QUICK_ACTION_GROUPS.map((group) => {
                        const GroupIcon = group.icon;
                        return (
                          <div key={group.id} className={s.quickSection}>
                            <div className={s.quickSectionHeader}>
                              <GroupIcon className={s.quickSectionIcon} />
                              <span className={s.quickSectionTitle}>
                                {group.title}
                              </span>
                            </div>

                            <div className={s.quickGrid}>
                              {group.items.map((id) => {
                                const action = QUICK_ACTIONS_MAP[id];
                                if (!action) return null;
                                const Icon = action.icon;
                                return (
                                  <button
                                    key={action.id}
                                    type="button"
                                    className={s.quickBtn}
                                    onClick={() => handleQuickActionClick(action)}
                                  >
                                    <span className={s.quickIconWrap}>
                                      <Icon className={s.quickIcon} />
                                    </span>
                                    <span className={s.quickLabel}>
                                      {action.label}
                                    </span>
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </>
              )}

              {messages.map((m, i) => {
                const isUser = m.role === 'user';

                let isSafetyNews = false;
                let isNoticeSummary = false;
                let isAccidentCases = false;
                let safetyArticlesHtml: string | null = null;
                let noticeArticlesHtml: string | null = null;
                let safeHtml: string;

                if (m.role === 'assistant') {
                  const rawHtml = m.content || '';

                  // ğŸ”¹ ì‚¬ê³ ì‚¬ë¡€ ì„¹ì…˜ ìˆëŠ”ì§€ ë¨¼ì € ì²´í¬
                  isAccidentCases = hasAccidentCasesInHtml(rawHtml);

                  if (isSafetyNewsHtml(rawHtml)) {
                    isSafetyNews = true;
                    safeHtml = extractSafetySummaryHtml(rawHtml);
                    safetyArticlesHtml = extractSafetyArticlesHtml(rawHtml);
                  } else if (isNoticeSummaryHtml(rawHtml)) {
                    // âœ… ì…ë²•ì˜ˆê³  ìš”ì•½
                    isNoticeSummary = true;
                    safeHtml = extractNoticeSummaryHtml(rawHtml); // ë³¸ë¬¸(ì œëª©+ìš”ì•½)ë§Œ
                    noticeArticlesHtml = extractNoticeArticlesHtml(rawHtml); // ìš°ì¸¡ íŒ¨ë„ìš©
                  } else {
                    safeHtml = cutHtmlBeforeEvidence(rawHtml);
                  }
                } else {
                  safeHtml = m.content;
                }

                const isIntro =
                  m.role === 'assistant' &&
                  (m.content === LAW_INTRO_TEXT ||
                    m.content === GUIDELINE_INTRO_TEXT ||
                    m.content === DOC_CREATE_INTRO_TEXT ||
                    m.content === EDU_INTRO_TEXT ||
                    m.content === DOC_REVIEW_INTRO_TEXT ||
                    m.content === ACCIDENT_INTRO_TEXT);
                
                const isSafetyDocDownload =
                  m.role === 'assistant' && m.content.includes('ì–‘ì‹ ë‹¤ìš´ë¡œë“œ');

                // ì¸íŠ¸ë¡œì´ê±°ë‚˜, ë¬¸ì„œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ì•ˆë‚´ë©´ ì•¡ì…˜ ìˆ¨ê¹€
                const hideActionRow = isIntro || isSafetyDocDownload;

                if (isUser) {
                  return (
                    <div key={i} className={s.userRow}>
                      <div className={s.userBubble}>
                        <div
                          className={s.userContent}
                          dangerouslySetInnerHTML={{ __html: m.content }}
                        />
                      </div>
                    </div>
                  );
                }

                return (
                  <div key={i} className={s.aiRow}>
                    <div
                      ref={(el) => {
                        contentRefs.current[i] = el;
                      }}
                      className={s.aiBubble}
                      dangerouslySetInnerHTML={{ __html: safeHtml }}
                    />

                    {!hideActionRow && (
                      <div className={s.actionRow}>
                        <div className={s.miniActions}>
                          {(!isSafetyNews && !isNoticeSummary) && (
                            <div className={s.miniActions}>
                              <button
                                className={s.iconBtn}
                                title="ë‹¤ì‹œ ìƒì„±"
                                onClick={() => handleRegenerate(i)}
                              >
                                <RotateCcw className={s.iconAction} />
                              </button>
                              <button
                                className={s.iconBtn}
                                title="ë³µì‚¬"
                                onClick={() =>
                                  handleCopy(i, m.content)
                                }
                              >
                                <Copy className={s.iconAction} />
                              </button>
                            </div>
                          )}
                        </div>
                        <button
                          className={s.evidenceBtn}
                          onClick={() => {
                            if (isSafetyNews) {
                              const htmlForRight =
                                safetyArticlesHtml && safetyArticlesHtml.trim().length > 0
                                  ? safetyArticlesHtml
                                  : extractSafetyArticlesHtml(m.content) || m.content;

                              openRightFromHtml(htmlForRight, {
                                mode: 'news',
                              });
                            } else if (isNoticeSummary) {
                              // âœ… ì…ë²•ì˜ˆê³ ìš©: ì œëª©ë§Œ + ë§í¬ ë¦¬ìŠ¤íŠ¸
                              const htmlForRight =
                                noticeArticlesHtml && noticeArticlesHtml.trim().length > 0
                                  ? noticeArticlesHtml
                                  : extractNoticeArticlesHtml(m.content) || m.content;

                              openRightFromHtml(htmlForRight, {
                                mode: 'lawNotice',
                              });
                            } else if (isAccidentCases) {
                              openRightFromHtml(m.content, {
                                mode: 'accident'
                              })
                            } else {
                              openRightFromHtml(m.content, {
                                mode: 'evidence',
                              });
                            }
                          }}
                        >
                          {isSafetyNews
                            ? 'ì°¸ê³  ê¸°ì‚¬ ëª©ë¡ í™•ì¸í•˜ê¸°'
                            : isNoticeSummary
                            ? 'ì°¸ê³  ì…ë²•ì˜ˆê³  ëª©ë¡ í™•ì¸í•˜ê¸°'
                            : isAccidentCases                    // ğŸ”¹ ì—¬ê¸° ì¶”ê°€
                            ? 'ì°¸ê³  ì‚¬ê³ ì‚¬ë¡€ í™•ì¸í•˜ê¸°'
                            : 'ê·¼ê±° ë° ì„œì‹ í™•ì¸í•˜ê¸°'}
                        </button>


                      </div>
                    )}
                  </div>
                );
              })}

              {activeHintTask && activeHints.length > 0 && (
                <div className={s.hintWrap}>
                  {activeHints.map((hint, idx) => (
                    <button
                      key={idx}
                      type="button"
                      className={s.hintChip}
                      onClick={() =>
                        handleHintClick(activeHintTask, hint)
                      }
                    >
                      {hint}
                    </button>
                  ))}
                </div>
              )}
              {loading && (
                <div className={s.loadingCard}>
                  <span>
                    {statusMessage ||
                      LOADING_MESSAGES[loadingMessageIndex]}
                  </span>
                  <span className={s.dots}>
                    <span>â€¢</span>
                    <span>â€¢</span>
                    <span>â€¢</span>
                  </span>
                </div>
              )}

              <div ref={endRef} />
              <div className={s.bottomSpacer} />
            </div>
          </div>

          {attachments.length > 0 && (
            <div className={s.attachList}>
              {attachments.map((file, idx) => (
                <div key={idx} className={s.attachChip}>
                  <Paperclip className={s.attachIcon} />
                  <span className={s.attachName}>{file.name}</span>
                  <button
                    type="button"
                    className={s.attachRemove}
                    onClick={() =>
                      setAttachments((prev) =>
                        prev.filter((_, i) => i !== idx),
                      )
                    }
                    aria-label="ì²¨ë¶€ ì‚­ì œ"
                  >
                    Ã—
                  </button>
                </div>
              ))}
            </div>
          )}

          <div
            className={s.inputRow}
            onDragOver={handleDragOver}
            onDrop={handleDrop}
          >
            <div className={s.inputWrap}>
              <div className={s.inputShell}>
                <button
                  type="button"
                  className={s.plusBtn}
                  onClick={() => setShowTaskModal(true)}
                  aria-label="ì‘ì—… ì„ íƒ"
                  title="ì‘ì—… ì„ íƒ"
                >
                  <Plus className={s.plusIcon} />
                </button>

                {currentTaskMeta && (
                  <div className={s.taskChip}>
                    <Search className={s.taskChipIcon} />
                    <span className={s.taskChipLabel}>
                      {currentTaskMeta.label}
                    </span>
                    <button
                      type="button"
                      className={s.taskChipClose}
                      onClick={() => setSelectedTask(null)}
                      aria-label="ì‘ì—… íƒœê·¸ ì œê±°"
                    >
                      Ã—
                    </button>
                  </div>
                )}

                <input
                  className={`${s.input} ${
                    currentTaskMeta ? s.inputHasChip : ''
                  } chat-input`}
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={onKey}
                  placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”"
                />
              </div>
            </div>

            <button
              type="button"
              className={s.attachBtn}
              onClick={() => fileInputRef.current?.click()}
              aria-label="íŒŒì¼ ì²¨ë¶€"
            >
              <Paperclip className={s.iconMd} />
            </button>

            <button
              onClick={handleSend}
              className={s.sendBtn}
              aria-label="ì „ì†¡"
            >
              <ArrowUp className={s.iconMdAccent} />
            </button>

            <input
              ref={fileInputRef}
              type="file"
              multiple
              style={{ display: 'none' }}
              onChange={handleFileChange}
            />
          </div>

          {copied && <div className={s.toast}>ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤</div>}
        </div>
      </section>

      {/* ì‘ì—… ì„ íƒ ëª¨ë‹¬ */}
      {showTaskModal && (
        <div
          role="dialog"
          aria-modal="true"
          aria-label="ì‘ì—… ì„ íƒ"
          className={s.typeModalOverlay}
          onClick={() => setShowTaskModal(false)}
        >
          <div
            className={s.taskModal}
            onClick={(e) => e.stopPropagation()}
          >
            <div className={s.typeHeader}>
              <h3 className={s.typeTitle}>ì‘ì—… ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</h3>
              <button
                type="button"
                className={s.typeCloseBtn}
                onClick={() => setShowTaskModal(false)}
                aria-label="ì‘ì—… ì„ íƒì°½ ë‹«ê¸°"
              >
                <span className={s.typeCloseIcon} aria-hidden="true">
                  Ã—
                </span>
              </button>
            </div>

            <div className={s.taskGrid}>
              {QUICK_ACTIONS.map((action) => {
                const Icon = action.icon;
                return (
                  <button
                    key={action.id}
                    type="button"
                    className={s.taskCard}
                    onClick={() => {
                      handleQuickActionClick(action);
                      setShowTaskModal(false);
                    }}
                  >
                    <Icon className={s.taskCardIcon} />
                    <span className={s.taskLabel}>{action.label}</span>
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {/* âœ… ë¡œê·¸ì¸ ëª¨ë‹¬ (ë¹„ë¡œê·¸ì¸ì¼ ë•Œ ê³„ì • ë²„íŠ¼ ëˆ„ë¥´ë©´ í‘œì‹œ) */}
      {showLoginModal && (
        <LoginPromptModal onClose={() => setShowLoginModal(false)} />
      )}
    </>
  );
}
